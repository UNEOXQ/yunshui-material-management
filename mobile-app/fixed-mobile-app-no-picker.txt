import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, Alert, ActivityIndicator, TextInput, Modal, Image } from 'react-native';

// API é…ç½®
const API_BASE_URL = 'http://192.168.68.95:3004/api';

// å®Œæ•´çš„ API æœå‹™
const apiService = {
  // èªè­‰ç›¸é—œ
  login: async (username: string, password: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });
      return await response.json();
    } catch (error) {
      return { success: false, error: error.message };
    }
  },

  // åŸºæç®¡ç†
  getMaterials: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/materials`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success && data.data) {
        return Array.isArray(data.data) ? data.data : data.data.materials || [];
      }
      return [];
    } catch (error) {
      console.error('å–å¾—åŸºæå¤±æ•—:', error);
      return [];
    }
  },

  createMaterial: async (token: string, material: any) => {
    try {
      const response = await fetch(`${API_BASE_URL}/materials`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(material),
      });
      return await response.json();
    } catch (error) {
      return { success: false, error: error.message };
    }
  },

  getCategories: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/materials/categories`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      return data.success ? data.data.categories : [];
    } catch (error) {
      return [];
    }
  },

  getSuppliers: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/materials/suppliers`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      return data.success ? data.data.suppliers : [];
    } catch (error) {
      return [];
    }
  },

  // è¨‚å–®ç®¡ç†
  getOrders: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/orders`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success && data.data) {
        return Array.isArray(data.data) ? data.data : data.data.orders || [];
      }
      return [];
    } catch (error) {
      return [];
    }
  },

  createOrder: async (token: string, order: any) => {
    try {
      const response = await fetch(`${API_BASE_URL}/orders`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(order),
      });
      return await response.json();
    } catch (error) {
      return { success: false, error: error.message };
    }
  },
};

export default function App() {
  // èªè­‰ç‹€æ…‹
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [authToken, setAuthToken] = useState('');
  const [currentUser, setCurrentUser] = useState(null);
  
  // ç™»å…¥è¡¨å–®
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [loginLoading, setLoginLoading] = useState(false);

  // å¿«é€Ÿç™»å…¥ç”¨æˆ¶åˆ—è¡¨
  const [quickLoginUsers, setQuickLoginUsers] = useState([
    { id: 'user-1', username: 'ç³»çµ±ç®¡ç†å“¡', password: 'admin123', role: 'ADMIN', email: 'admin@yunshui.com', originalUsername: 'admin' },
    { id: 'user-2', username: 'Jeffrey', password: 'pm123', role: 'PM', email: 'pm001@yunshui.com', originalUsername: 'pm001' },
    { id: 'user-3', username: 'Miya', password: 'am123', role: 'AM', email: 'am001@yunshui.com', originalUsername: 'am001' },
    { id: 'user-4', username: 'Mark', password: 'wh123', role: 'WAREHOUSE', email: 'warehouse001@yunshui.com', originalUsername: 'warehouse001' },
    { id: 'id-2064', username: 'Erica', password: 'default123', role: 'AM', email: 'Erica@yunshui.com', originalUsername: 'Erica' },
    { id: 'id-2065', username: 'LUKE', password: 'default123', role: 'PM', email: 'LUKE@yunshui.com', originalUsername: 'LUKE' }
  ]);

  // ä¸»è¦ç‹€æ…‹
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [materials, setMaterials] = useState([]);
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(false);

  // åŸºæè¡¨å–®ç‹€æ…‹
  const [showMaterialForm, setShowMaterialForm] = useState(false);
  const [materialForm, setMaterialForm] = useState({
    name: '',
    category: '',
    supplier: '',
    price: '',
    quantity: '',
    type: 'AUXILIARY'
  });
  const [categories, setCategories] = useState([]);
  const [suppliers, setSuppliers] = useState([]);

  // è¨‚å–®è¡¨å–®ç‹€æ…‹
  const [showOrderForm, setShowOrderForm] = useState(false);
  const [orderForm, setOrderForm] = useState({
    customerName: '',
    projectName: '',
    totalAmount: '',
    status: 'PENDING'
  });
  const [selectedMaterials, setSelectedMaterials] = useState([]);

  // é¡å‹é¸æ“‡å™¨ç‹€æ…‹
  const [showTypeSelector, setShowTypeSelector] = useState(false);

  // æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œè¼‰å…¥å¿«é€Ÿç™»å…¥ç”¨æˆ¶
  useEffect(() => {
    checkAuthStatus();
    loadQuickLoginUsers();
  }, []);

  const checkAuthStatus = async () => {
    // æª¢æŸ¥æœ¬åœ°å­˜å„²çš„ token
  };

  // è¼‰å…¥å¿«é€Ÿç™»å…¥ç”¨æˆ¶åˆ—è¡¨
  const loadQuickLoginUsers = async () => {
    try {
      const adminResponse = await fetch(`${API_BASE_URL}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: 'admin', password: 'admin123' })
      });
      
      if (adminResponse.ok) {
        const adminResult = await adminResponse.json();
        if (adminResult.success && adminResult.data) {
          const token = adminResult.data.token;
          
          const usersResponse = await fetch(`${API_BASE_URL}/users`, {
            method: 'GET',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (usersResponse.ok) {
            const usersResult = await usersResponse.json();
            if (usersResult.success && usersResult.data) {
              const allUsers = usersResult.data.users || usersResult.data;
              
              const quickLoginUsers = allUsers.map((user: any) => {
                let password = 'default123';
                let originalUsername = user.username;
                
                if (user.id === 'user-1') {
                  password = 'admin123';
                  originalUsername = 'admin';
                } else if (user.id === 'user-2') {
                  password = 'pm123';
                  originalUsername = 'pm001';
                } else if (user.id === 'user-3') {
                  password = 'am123';
                  originalUsername = 'am001';
                } else if (user.id === 'user-4') {
                  password = 'wh123';
                  originalUsername = 'warehouse001';
                }
                
                return {
                  id: user.id,
                  username: user.username,
                  password: password,
                  role: user.role,
                  email: user.email,
                  originalUsername: originalUsername
                };
              });
              
              setQuickLoginUsers(quickLoginUsers);
            }
          }
        }
      }
    } catch (error) {
      console.log('Failed to load quick login users:', error);
    }
  };

  // ä¸€èˆ¬ç™»å…¥è™•ç†
  const handleLogin = async () => {
    if (!loginForm.username || !loginForm.password) {
      Alert.alert('éŒ¯èª¤', 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
      return;
    }

    setLoginLoading(true);
    const result = await apiService.login(loginForm.username, loginForm.password);
    
    if (result.success) {
      setAuthToken(result.data.token);
      setCurrentUser(result.data.user);
      setIsLoggedIn(true);
      loadInitialData(result.data.token);
    } else {
      Alert.alert('ç™»å…¥å¤±æ•—', result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
    }
    setLoginLoading(false);
  };

  // å¿«é€Ÿç™»å…¥è™•ç†
  const handleQuickLogin = async (account: any) => {
    setLoginLoading(true);
    const result = await apiService.login(account.originalUsername, account.password);
    
    if (result.success) {
      setAuthToken(result.data.token);
      setCurrentUser(result.data.user);
      setIsLoggedIn(true);
      loadInitialData(result.data.token);
    } else {
      Alert.alert('å¿«é€Ÿç™»å…¥å¤±æ•—', result.message || 'ç™»å…¥å¤±æ•—');
    }
    setLoginLoading(false);
  };

  // è¼‰å…¥åˆå§‹è³‡æ–™
  const loadInitialData = async (token: string) => {
    setLoading(true);
    try {
      const [materialsData, ordersData, categoriesData, suppliersData] = await Promise.all([
        apiService.getMaterials(token),
        apiService.getOrders(token),
        apiService.getCategories(token),
        apiService.getSuppliers(token),
      ]);
      
      setMaterials(materialsData);
      setOrders(ordersData);
      setCategories(categoriesData);
      setSuppliers(suppliersData);
    } catch (error) {
      Alert.alert('éŒ¯èª¤', 'è¼‰å…¥è³‡æ–™å¤±æ•—');
    } finally {
      setLoading(false);
    }
  };

  // ç™»å‡º
  const handleLogout = () => {
    setIsLoggedIn(false);
    setAuthToken('');
    setCurrentUser(null);
    setCurrentPage('dashboard');
  };

  // æ–°å¢åŸºæ
  const handleAddMaterial = async () => {
    if (!materialForm.name || !materialForm.category || !materialForm.price) {
      Alert.alert('éŒ¯èª¤', 'è«‹å¡«å¯«å¿…è¦æ¬„ä½ï¼šåç¨±ã€åˆ†é¡ã€åƒ¹æ ¼');
      return;
    }

    setLoading(true);
    const result = await apiService.createMaterial(authToken, {
      name: materialForm.name,
      category: materialForm.category,
      supplier: materialForm.supplier,
      price: parseFloat(materialForm.price),
      quantity: parseInt(materialForm.quantity) || 0,
      type: materialForm.type
    });

    if (result.success) {
      Alert.alert('æˆåŠŸ', 'åŸºææ–°å¢æˆåŠŸ');
      setShowMaterialForm(false);
      setMaterialForm({
        name: '', category: '', supplier: '', price: '', quantity: '', type: 'AUXILIARY'
      });
      loadInitialData(authToken);
    } else {
      Alert.alert('éŒ¯èª¤', result.error || 'æ–°å¢åŸºæå¤±æ•—');
    }
    setLoading(false);
  };

  // æ–°å¢è¨‚å–®
  const handleAddOrder = async () => {
    if (!orderForm.customerName) {
      Alert.alert('éŒ¯èª¤', 'è«‹å¡«å¯«å®¢æˆ¶åç¨±');
      return;
    }

    setLoading(true);
    const result = await apiService.createOrder(authToken, {
      customerName: orderForm.customerName,
      projectName: orderForm.projectName,
      status: orderForm.status
    });

    if (result.success) {
      Alert.alert('æˆåŠŸ', 'è¨‚å–®å»ºç«‹æˆåŠŸ');
      setShowOrderForm(false);
      setOrderForm({ customerName: '', projectName: '', totalAmount: '', status: 'PENDING' });
      loadInitialData(authToken);
    } else {
      Alert.alert('éŒ¯èª¤', result.error || 'å»ºç«‹è¨‚å–®å¤±æ•—');
    }
    setLoading(false);
  };

  // ç²å–è§’è‰²é¡¯ç¤ºæ–‡å­—
  const getRoleDisplayText = (role: string) => {
    const roleMap = {
      'ADMIN': 'ç³»çµ±ç®¡ç†å“¡',
      'PM': 'å°ˆæ¡ˆç¶“ç†',
      'AM': 'å€åŸŸç¶“ç†',
      'WAREHOUSE': 'å€‰ç®¡äººå“¡'
    };
    return roleMap[role] || role;
  };

  // ç²å–è§’è‰²é¡è‰²
  const getRoleColor = (role: string) => {
    const colorMap = {
      'ADMIN': '#dc3545',
      'PM': '#007bff',
      'AM': '#28a745',
      'WAREHOUSE': '#ffc107'
    };
    return colorMap[role] || '#6c757d';
  };

  // ç™»å…¥ç•«é¢
  if (!isLoggedIn) {
    return (
      <ScrollView style={styles.loginContainer}>
        <View style={styles.loginForm}>
          <Text style={styles.loginTitle}>ğŸ—ï¸ é›²æ°´åŸºæç®¡ç†ç³»çµ±</Text>
          <Text style={styles.loginSubtitle}>æ‰‹æ©Ÿç‰ˆç™»å…¥</Text>
          
          {/* å¿«é€Ÿç™»å…¥å€åŸŸ */}
          <View style={styles.quickLoginSection}>
            <Text style={styles.quickLoginTitle}>å¿«é€Ÿç™»å…¥</Text>
            <View style={styles.quickLoginGrid}>
              {quickLoginUsers.map((account) => (
                <TouchableOpacity
                  key={account.id}
                  style={[styles.quickLoginButton, { borderColor: getRoleColor(account.role) }]}
                  onPress={() => handleQuickLogin(account)}
                  disabled={loginLoading}
                >
                  <Text style={[styles.quickLoginName, { color: getRoleColor(account.role) }]}>
                    {account.username}
                  </Text>
                  <Text style={styles.quickLoginRole}>
                    {getRoleDisplayText(account.role)}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
          </View>

          {/* åˆ†éš”ç·š */}
          <View style={styles.divider}>
            <View style={styles.dividerLine} />
            <Text style={styles.dividerText}>æˆ–</Text>
            <View style={styles.dividerLine} />
          </View>
          
          {/* æ‰‹å‹•ç™»å…¥å€åŸŸ */}
          <View style={styles.manualLoginSection}>
            <Text style={styles.manualLoginTitle}>æ‰‹å‹•ç™»å…¥</Text>
            <TextInput
              style={styles.loginInput}
              placeholder="å¸³è™Ÿ"
              value={loginForm.username}
              onChangeText={(text) => setLoginForm(prev => ({ ...prev, username: text }))}
              autoCapitalize="none"
            />
            
            <TextInput
              style={styles.loginInput}
              placeholder="å¯†ç¢¼"
              value={loginForm.password}
              onChangeText={(text) => setLoginForm(prev => ({ ...prev, password: text }))}
              secureTextEntry
            />
            
            <TouchableOpacity 
              style={styles.loginButton} 
              onPress={handleLogin}
              disabled={loginLoading}
            >
              {loginLoading ? (
                <ActivityIndicator color="#fff" />
              ) : (
                <Text style={styles.loginButtonText}>ç™»å…¥</Text>
              )}
            </TouchableOpacity>
          </View>
        </View>
      </ScrollView>
    );
  }

  // å„€è¡¨æ¿
  const renderDashboard = () => (
    <ScrollView style={styles.container}>
      <View style={styles.header}>
        <Text style={styles.title}>ğŸ—ï¸ é›²æ°´åŸºæç®¡ç†ç³»çµ±</Text>
        <Text style={styles.subtitle}>æ­¡è¿ï¼Œ{currentUser?.username}</Text>
        <Text style={styles.userRole}>è§’è‰²ï¼š{getRoleDisplayText(currentUser?.role)}</Text>
        <TouchableOpacity style={styles.logoutButton} onPress={handleLogout}>
          <Text style={styles.logoutText}>ç™»å‡º</Text>
        </TouchableOpacity>
      </View>
      
      <View style={styles.statsContainer}>
        <View style={styles.statCard}>
          <Text style={styles.statNumber}>{orders.length}</Text>
          <Text style={styles.statLabel}>ç¸½è¨‚å–®æ•¸</Text>
        </View>
        <View style={styles.statCard}>
          <Text style={styles.statNumber}>{materials.length}</Text>
          <Text style={styles.statLabel}>åŸºæç¨®é¡</Text>
        </View>
      </View>

      <View style={styles.quickActions}>
        <TouchableOpacity style={styles.actionButton} onPress={() => setCurrentPage('materials')}>
          <Text style={styles.actionText}>ğŸ“¦ åŸºæç®¡ç†</Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.actionButton} onPress={() => setCurrentPage('orders')}>
          <Text style={styles.actionText}>ğŸ“‹ è¨‚å–®ç®¡ç†</Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.actionButton} onPress={() => setCurrentPage('status')}>
          <Text style={styles.actionText}>ğŸ“Š ç‹€æ…‹ç®¡ç†</Text>
        </TouchableOpacity>
      </View>
    </ScrollView>
  );

  // åŸºæç®¡ç†
  const renderMaterials = () => (
    <ScrollView style={styles.container}>
      <View style={styles.pageHeader}>
        <Text style={styles.pageTitle}>ğŸ“¦ åŸºæç®¡ç†</Text>
        <TouchableOpacity style={styles.addButton} onPress={() => setShowMaterialForm(true)}>
          <Text style={styles.addButtonText}>+ æ–°å¢</Text>
        </TouchableOpacity>
      </View>
      
      {materials.length === 0 ? (
        <Text style={styles.emptyText}>æš«ç„¡åŸºæè³‡æ–™ï¼Œè«‹å…ˆæ–°å¢åŸºæ</Text>
      ) : (
        materials.map((material, index) => (
          <View key={material.id || index} style={styles.materialCard}>
            <View style={styles.materialInfo}>
              <Text style={styles.materialName}>{material.name}</Text>
              <Text style={styles.materialCategory}>åˆ†é¡: {material.category}</Text>
              <Text style={styles.materialSupplier}>ä¾›æ‡‰å•†: {material.supplier || 'æœªæŒ‡å®š'}</Text>
              <Text style={styles.materialType}>é¡å‹: {material.type === 'AUXILIARY' ? 'è¼”æ' : 'å®Œæˆæ'}</Text>
              <Text style={styles.materialPrice}>åƒ¹æ ¼: CAD ${material.price}</Text>
              <Text style={styles.materialQuantity}>åº«å­˜: {material.quantity}</Text>
            </View>
          </View>
        ))
      )}

      <TouchableOpacity style={styles.backButton} onPress={() => setCurrentPage('dashboard')}>
        <Text style={styles.backText}>â† è¿”å›å„€è¡¨æ¿</Text>
      </TouchableOpacity>
    </ScrollView>
  );

  // è¨‚å–®ç®¡ç†
  const renderOrders = () => (
    <ScrollView style={styles.container}>
      <View style={styles.pageHeader}>
        <Text style={styles.pageTitle}>ğŸ“‹ è¨‚å–®ç®¡ç†</Text>
        <TouchableOpacity style={styles.addButton} onPress={() => setShowOrderForm(true)}>
          <Text style={styles.addButtonText}>+ æ–°å¢</Text>
        </TouchableOpacity>
      </View>
      
      {orders.length === 0 ? (
        <Text style={styles.emptyText}>æš«ç„¡è¨‚å–®è³‡æ–™</Text>
      ) : (
        orders.map((order, index) => (
          <View key={order.id || index} style={styles.orderCard}>
            <Text style={styles.orderNumber}>è¨‚å–® #{order.orderNumber || order.id}</Text>
            <Text style={styles.orderCustomer}>å®¢æˆ¶: {order.customerName || 'æœªçŸ¥å®¢æˆ¶'}</Text>
            <Text style={styles.orderProject}>å°ˆæ¡ˆ: {order.projectName || 'æœªæŒ‡å®š'}</Text>
            <Text style={styles.orderStatus}>ç‹€æ…‹: {order.status || 'å¾…è™•ç†'}</Text>
            <Text style={styles.orderAmount}>é‡‘é¡: CAD ${order.totalAmount || 0}</Text>
            <Text style={styles.orderDate}>æ—¥æœŸ: {order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'æœªçŸ¥'}</Text>
          </View>
        ))
      )}

      <TouchableOpacity style={styles.backButton} onPress={() => setCurrentPage('dashboard')}>
        <Text style={styles.backText}>â† è¿”å›å„€è¡¨æ¿</Text>
      </TouchableOpacity>
    </ScrollView>
  );

  // ç‹€æ…‹ç®¡ç†
  const renderStatus = () => (
    <ScrollView style={styles.container}>
      <Text style={styles.pageTitle}>ğŸ“Š ç‹€æ…‹ç®¡ç†</Text>
      <Text style={styles.comingSoon}>åŠŸèƒ½é–‹ç™¼ä¸­...</Text>
      <TouchableOpacity style={styles.backButton} onPress={() => setCurrentPage('dashboard')}>
        <Text style={styles.backText}>â† è¿”å›å„€è¡¨æ¿</Text>
      </TouchableOpacity>
    </ScrollView>
  );

  return (
    <View style={styles.app}>
      {currentPage === 'dashboard' && renderDashboard()}
      {currentPage === 'materials' && renderMaterials()}
      {currentPage === 'orders' && renderOrders()}
      {currentPage === 'status' && renderStatus()}
      
      {/* åº•éƒ¨å°èˆª */}
      <View style={styles.bottomNav}>
        <TouchableOpacity style={styles.navButton} onPress={() => setCurrentPage('dashboard')}>
          <Text style={[styles.navText, currentPage === 'dashboard' && styles.activeNav]}>ğŸ  é¦–é </Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.navButton} onPress={() => setCurrentPage('materials')}>
          <Text style={[styles.navText, currentPage === 'materials' && styles.activeNav]}>ğŸ“¦ åŸºæ</Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.navButton} onPress={() => setCurrentPage('orders')}>
          <Text style={[styles.navText, currentPage === 'orders' && styles.activeNav]}>ğŸ“‹ è¨‚å–®</Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.navButton} onPress={() => setCurrentPage('status')}>
          <Text style={[styles.navText, currentPage === 'status' && styles.activeNav]}>ğŸ“Š ç‹€æ…‹</Text>
        </TouchableOpacity>
      </View>

      {/* åŸºææ–°å¢è¡¨å–® Modal */}
      <Modal visible={showMaterialForm} animationType="slide" transparent>
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>æ–°å¢åŸºæ</Text>
            
            <TextInput
              style={styles.input}
              placeholder="åŸºæåç¨± *"
              value={materialForm.name}
              onChangeText={(text) => setMaterialForm(prev => ({ ...prev, name: text }))}
            />
            
            <TextInput
              style={styles.input}
              placeholder="åˆ†é¡ *"
              value={materialForm.category}
              onChangeText={(text) => setMaterialForm(prev => ({ ...prev, category: text }))}
            />
            
            <TextInput
              style={styles.input}
              placeholder="ä¾›æ‡‰å•†"
              value={materialForm.supplier}
              onChangeText={(text) => setMaterialForm(prev => ({ ...prev, supplier: text }))}
            />
            
            {/* ææ–™é¡å‹é¸æ“‡ */}
            <View style={styles.typeSelector}>
              <Text style={styles.typeSelectorLabel}>ææ–™é¡å‹:</Text>
              <View style={styles.typeButtons}>
                <TouchableOpacity
                  style={[styles.typeButton, materialForm.type === 'AUXILIARY' && styles.typeButtonActive]}
                  onPress={() => setMaterialForm(prev => ({ ...prev, type: 'AUXILIARY' }))}
                >
                  <Text style={[styles.typeButtonText, materialForm.type === 'AUXILIARY' && styles.typeButtonTextActive]}>
                    è¼”æ
                  </Text>
                </TouchableOpacity>
                <TouchableOpacity
                  style={[styles.typeButton, materialForm.type === 'FINISHED' && styles.typeButtonActive]}
                  onPress={() => setMaterialForm(prev => ({ ...prev, type: 'FINISHED' }))}
                >
                  <Text style={[styles.typeButtonText, materialForm.type === 'FINISHED' && styles.typeButtonTextActive]}>
                    å®Œæˆæ
                  </Text>
                </TouchableOpacity>
              </View>
            </View>
            
            <TextInput
              style={styles.input}
              placeholder="åƒ¹æ ¼ (CAD) *"
              value={materialForm.price}
              onChangeText={(text) => setMaterialForm(prev => ({ ...prev, price: text }))}
              keyboardType="numeric"
            />
            
            <TextInput
              style={styles.input}
              placeholder="åº«å­˜æ•¸é‡"
              value={materialForm.quantity}
              onChangeText={(text) => setMaterialForm(prev => ({ ...prev, quantity: text }))}
              keyboardType="numeric"
            />
            
            <View style={styles.modalButtons}>
              <TouchableOpacity style={styles.cancelButton} onPress={() => setShowMaterialForm(false)}>
                <Text style={styles.cancelText}>å–æ¶ˆ</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.saveButton} onPress={handleAddMaterial}>
                <Text style={styles.saveText}>å„²å­˜</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* è¨‚å–®æ–°å¢è¡¨å–® Modal */}
      <Modal visible={showOrderForm} animationType="slide" transparent>
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>æ–°å¢è¨‚å–®</Text>
            
            <TextInput
              style={styles.input}
              placeholder="å®¢æˆ¶åç¨± *"
              value={orderForm.customerName}
              onChangeText={(text) => setOrderForm(prev => ({ ...prev, customerName: text }))}
            />
            
            <TextInput
              style={styles.input}
              placeholder="å°ˆæ¡ˆåç¨±"
              value={orderForm.projectName}
              onChangeText={(text) => setOrderForm(prev => ({ ...prev, projectName: text }))}
            />
            
            <View style={styles.modalButtons}>
              <TouchableOpacity style={styles.cancelButton} onPress={() => setShowOrderForm(false)}>
                <Text style={styles.cancelText}>å–æ¶ˆ</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.saveButton} onPress={handleAddOrder}>
                <Text style={styles.saveText}>å»ºç«‹è¨‚å–®</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {loading && (
        <View style={styles.loadingOverlay}>
          <ActivityIndicator size="large" color="#007bff" />
          <Text style={styles.loadingText}>è™•ç†ä¸­...</Text>
        </View>
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  app: { flex: 1, backgroundColor: '#f5f5f5' },
  
  // ç™»å…¥ç›¸é—œ
  loginContainer: { flex: 1, backgroundColor: '#007bff', padding: 20 },
  loginForm: { backgroundColor: '#fff', padding: 30, borderRadius: 15, marginTop: 50 },
  loginTitle: { fontSize: 24, fontWeight: 'bold', textAlign: 'center', marginBottom: 10, color: '#007bff' },
  loginSubtitle: { fontSize: 16, textAlign: 'center', marginBottom: 30, color: '#666' },
  
  // å¿«é€Ÿç™»å…¥
  quickLoginSection: { marginBottom: 20 },
  quickLoginTitle: { fontSize: 18, fontWeight: 'bold', textAlign: 'center', marginBottom: 15, color: '#333' },
  quickLoginGrid: { flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'space-between' },
  quickLoginButton: { 
    width: '48%', 
    backgroundColor: '#fff', 
    borderWidth: 2, 
    borderRadius: 10, 
    padding: 15, 
    marginBottom: 10, 
    alignItems: 'center',
    elevation: 2
  },
  quickLoginName: { fontSize: 16, fontWeight: 'bold', marginBottom: 5 },
  quickLoginRole: { fontSize: 12, color: '#666' },
  
  // åˆ†éš”ç·š
  divider: { flexDirection: 'row', alignItems: 'center', marginVertical: 20 },
  dividerLine: { flex: 1, height: 1, backgroundColor: '#ddd' },
  dividerText: { marginHorizontal: 15, color: '#666', fontSize: 14 },
  
  // æ‰‹å‹•ç™»å…¥
  manualLoginSection: {},
  manualLoginTitle: { fontSize: 16, fontWeight: 'bold', textAlign: 'center', marginBottom: 15, color: '#333' },
  loginInput: { borderWidth: 1, borderColor: '#ddd', borderRadius: 8, padding: 15, marginBottom: 15, fontSize: 16 },
  loginButton: { backgroundColor: '#007bff', padding: 15, borderRadius: 8, alignItems: 'center' },
  loginButtonText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  
  // ä¸»è¦ä½ˆå±€
  container: { flex: 1, padding: 20 },
  header: { alignItems: 'center', marginBottom: 30 },
  title: { fontSize: 24, fontWeight: 'bold', color: '#007bff', marginBottom: 5 },
  subtitle: { fontSize: 16, color: '#666', marginBottom: 5 },
  userRole: { fontSize: 14, color: '#28a745', marginBottom: 10 },
  logoutButton: { backgroundColor: '#dc3545', paddingHorizontal: 15, paddingVertical: 8, borderRadius: 5 },
  logoutText: { color: '#fff', fontSize: 14 },
  
  // çµ±è¨ˆå¡ç‰‡
  statsContainer: { flexDirection: 'row', justifyContent: 'space-around', marginBottom: 30 },
  statCard: { backgroundColor: '#fff', padding: 20, borderRadius: 10, alignItems: 'center', minWidth: 120, elevation: 3 },
  statNumber: { fontSize: 32, fontWeight: 'bold', color: '#007bff' },
  statLabel: { fontSize: 14, color: '#666', marginTop: 5 },
  
  // å¿«é€Ÿæ“ä½œ
  quickActions: { gap: 15 },
  actionButton: { backgroundColor: '#007bff', padding: 15, borderRadius: 10, alignItems: 'center' },
  actionText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  
  // é é¢æ¨™é¡Œ
  pageHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 },
  pageTitle: { fontSize: 24, fontWeight: 'bold', color: '#007bff' },
  addButton: { backgroundColor: '#28a745', paddingHorizontal: 15, paddingVertical: 8, borderRadius: 8 },
  addButtonText: { color: '#fff', fontSize: 14, fontWeight: 'bold' },
  
  // åŸºæå¡ç‰‡
  materialCard: { backgroundColor: '#fff', padding: 15, borderRadius: 10, marginBottom: 15, elevation: 2 },
  materialInfo: { flex: 1 },
  materialName: { fontSize: 18, fontWeight: 'bold', color: '#333', marginBottom: 5 },
  materialCategory: { fontSize: 14, color: '#666', marginBottom: 3 },
  materialSupplier: { fontSize: 14, color: '#666', marginBottom: 3 },
  materialType: { fontSize: 14, color: '#007bff', marginBottom: 3 },
  materialPrice: { fontSize: 16, color: '#28a745', fontWeight: 'bold', marginBottom: 3 },
  materialQuantity: { fontSize: 14, color: '#666' },
  
  // è¨‚å–®å¡ç‰‡
  orderCard: { backgroundColor: '#fff', padding: 15, borderRadius: 10, marginBottom: 15, elevation: 2 },
  orderNumber: { fontSize: 16, fontWeight: 'bold', color: '#333', marginBottom: 5 },
  orderCustomer: { fontSize: 14, color: '#666', marginBottom: 3 },
  orderProject: { fontSize: 14, color: '#666', marginBottom: 3 },
  orderStatus: { fontSize: 14, color: '#ffc107', marginBottom: 3 },
  orderAmount: { fontSize: 16, color: '#28a745', fontWeight: 'bold', marginBottom: 3 },
  orderDate: { fontSize: 12, color: '#999', marginBottom: 10 },
  
  // Modal
  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', alignItems: 'center' },
  modalContent: { backgroundColor: '#fff', padding: 20, borderRadius: 15, width: '90%', maxHeight: '80%' },
  modalTitle: { fontSize: 20, fontWeight: 'bold', textAlign: 'center', marginBottom: 20, color: '#333' },
  input: { borderWidth: 1, borderColor: '#ddd', borderRadius: 8, padding: 12, marginBottom: 15, fontSize: 16 },
  
  // é¡å‹é¸æ“‡å™¨
  typeSelector: { marginBottom: 15 },
  typeSelectorLabel: { fontSize: 16, color: '#333', marginBottom: 10 },
  typeButtons: { flexDirection: 'row', gap: 10 },
  typeButton: { flex: 1, padding: 12, borderRadius: 8, borderWidth: 1, borderColor: '#ddd', alignItems: 'center' },
  typeButtonActive: { backgroundColor: '#007bff', borderColor: '#007bff' },
  typeButtonText: { fontSize: 16, color: '#666' },
  typeButtonTextActive: { color: '#fff', fontWeight: 'bold' },
  
  // æŒ‰éˆ•
  modalButtons: { flexDirection: 'row', justifyContent: 'space-between', gap: 10, marginTop: 20 },
  cancelButton: { flex: 1, backgroundColor: '#6c757d', padding: 12, borderRadius: 8, alignItems: 'center' },
  cancelText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  saveButton: { flex: 1, backgroundColor: '#28a745', padding: 12, borderRadius: 8, alignItems: 'center' },
  saveText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  
  backButton: { backgroundColor: '#6c757d', padding: 12, borderRadius: 8, alignItems: 'center', marginTop: 20 },
  backText: { color: '#fff', fontSize: 16 },
  
  // åº•éƒ¨å°èˆª
  bottomNav: { flexDirection: 'row', backgroundColor: '#fff', paddingVertical: 10, borderTopWidth: 1, borderTopColor: '#ddd' },
  navButton: { flex: 1, alignItems: 'center', paddingVertical: 10 },
  navText: { fontSize: 12, color: '#007bff' },
  activeNav: { fontWeight: 'bold', color: '#0056b3' },
  
  // è¼‰å…¥è¦†è“‹å±¤
  loadingOverlay: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', alignItems: 'center' },
  loadingText: { color: '#fff', marginTop: 10, fontSize: 16 },
  
  // å…¶ä»–
  emptyText: { textAlign: 'center', color: '#666', fontSize: 16, marginVertical: 40 },
  comingSoon: { textAlign: 'center', color: '#666', fontSize: 16, marginVertical: 40 },
});