import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, ScrollView, Alert, ActivityIndicator, TextInput, Modal, BackHandler } from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';

// API é…ç½®
const API_BASE_URL = 'http://192.168.68.95:3004/api';

// å®Œæ•´çš„ API æœå‹™
const apiService = {
  // èªè­‰ç›¸é—œ
  login: async (username: string, password: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });
      return await response.json();
    } catch (error) {
      return { success: false, error: error.message };
    }
  },

  // åŸºæç®¡ç†
  getMaterials: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/materials`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success && data.data) {
        return Array.isArray(data.data) ? data.data : data.data.materials || [];
      }
      return [];
    } catch (error) {
      console.error('å–å¾—åŸºæå¤±æ•—:', error);
      return [];
    }
  },

  // è¨‚å–®ç®¡ç† - æ‰€æœ‰è¨‚å–® (ä¿®å¾©ç‰ˆ)
  getAllOrders: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/orders`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      console.log('All orders response:', data);
      if (data.success && data.data) {
        return Array.isArray(data.data) ? data.data : data.data.orders || [];
      }
      return [];
    } catch (error) {
      console.error('å–å¾—æ‰€æœ‰è¨‚å–®å¤±æ•—:', error);
      return [];
    }
  },

  // è¨‚å–®ç®¡ç† - è¼”æè¨‚å–®
  getAuxiliaryOrders: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/orders/auxiliary`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      console.log('Auxiliary orders response:', data);
      if (data.success && data.data) {
        return Array.isArray(data.data) ? data.data : data.data.orders || [];
      }
      return [];
    } catch (error) {
      console.error('å–å¾—è¼”æè¨‚å–®å¤±æ•—:', error);
      return [];
    }
  },

  // è¨‚å–®ç®¡ç† - å®Œæˆæè¨‚å–®
  getFinishedOrders: async (token: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/orders/finished`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      console.log('Finished orders response:', data);
      if (data.success && data.data) {
        return Array.isArray(data.data) ? data.data : data.data.orders || [];
      }
      return [];
    } catch (error) {
      console.error('å–å¾—å®Œæˆæè¨‚å–®å¤±æ•—:', error);
      return [];
    }
  },

  // å»ºç«‹è¼”æè¨‚å–®
  createAuxiliaryOrder: async (token: string, orderData: any) => {
    try {
      const response = await fetch(`${API_BASE_URL}/orders/auxiliary`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(orderData),
      });
      return await response.json();
    } catch (error) {
      return { success: false, error: error.message };
    }
  },

  // å»ºç«‹å®Œæˆæè¨‚å–®
  createFinishedOrder: async (token: string, orderData: any) => {
    try {
      const response = await fetch(`${API_BASE_URL}/orders/finished`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(orderData),
      });
      return await response.json();
    } catch (error) {
      return { success: false, error: error.message };
    }
  },
};

export default function App() {
  const insets = useSafeAreaInsets();
  
  // èªè­‰ç‹€æ…‹
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [authToken, setAuthToken] = useState('');
  const [currentUser, setCurrentUser] = useState(null);
  
  // ç™»å…¥è¡¨å–®
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [loginLoading, setLoginLoading] = useState(false);

  // å¿«é€Ÿç™»å…¥ç”¨æˆ¶åˆ—è¡¨
  const [quickLoginUsers, setQuickLoginUsers] = useState([
    { id: 'user-1', username: 'ç³»çµ±ç®¡ç†å“¡', password: 'admin123', role: 'ADMIN', email: 'admin@yunshui.com', originalUsername: 'admin' },
    { id: 'user-2', username: 'Jeffrey', password: 'pm123', role: 'PM', email: 'pm001@yunshui.com', originalUsername: 'pm001' },
    { id: 'user-3', username: 'Miya', password: 'am123', role: 'AM', email: 'am001@yunshui.com', originalUsername: 'am001' },
    { id: 'user-4', username: 'Mark', password: 'wh123', role: 'WAREHOUSE', email: 'warehouse001@yunshui.com', originalUsername: 'warehouse001' },
    { id: 'id-2064', username: 'Erica', password: 'default123', role: 'AM', email: 'Erica@yunshui.com', originalUsername: 'Erica' },
    { id: 'id-2065', username: 'LUKE', password: 'default123', role: 'PM', email: 'LUKE@yunshui.com', originalUsername: 'LUKE' }
  ]);

  // ä¸»è¦ç‹€æ…‹
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [materials, setMaterials] = useState([]);
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(false);

  // ææ–™é¸æ“‡ç‹€æ…‹
  const [showMaterialSelection, setShowMaterialSelection] = useState(false);
  const [selectedMaterials, setSelectedMaterials] = useState([]);
  const [materialType, setMaterialType] = useState('AUXILIARY');

  // ç¡¬é«”è¿”å›éµè™•ç†
  useEffect(() => {
    const backAction = () => {
      if (showMaterialSelection) {
        setShowMaterialSelection(false);
        return true;
      }
      
      if (currentPage !== 'dashboard') {
        setCurrentPage('dashboard');
        return true;
      }
      
      return false; // è®“ç³»çµ±è™•ç†è¿”å›éµï¼ˆé€€å‡º Appï¼‰
    };

    const backHandler = BackHandler.addEventListener('hardwareBackPress', backAction);
    return () => backHandler.remove();
  }, [currentPage, showMaterialSelection]);

  // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
  useEffect(() => {
    checkAuthStatus();
  }, []);

  // ç•¶ç”¨æˆ¶ç™»å…¥å¾Œè¼‰å…¥è³‡æ–™
  useEffect(() => {
    if (isLoggedIn && authToken && currentUser) {
      loadInitialData(authToken);
    }
  }, [isLoggedIn, authToken, currentUser]);

  const checkAuthStatus = async () => {
    // æª¢æŸ¥æœ¬åœ°å­˜å„²çš„ token
  };

  // ä¸€èˆ¬ç™»å…¥è™•ç†
  const handleLogin = async () => {
    if (!loginForm.username || !loginForm.password) {
      Alert.alert('éŒ¯èª¤', 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
      return;
    }

    setLoginLoading(true);
    const result = await apiService.login(loginForm.username, loginForm.password);
    
    if (result.success) {
      setAuthToken(result.data.token);
      setCurrentUser(result.data.user);
      setIsLoggedIn(true);
      // loadInitialData æœƒåœ¨ useEffect ä¸­è‡ªå‹•åŸ·è¡Œ
    } else {
      Alert.alert('ç™»å…¥å¤±æ•—', result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
    }
    setLoginLoading(false);
  };

  // å¿«é€Ÿç™»å…¥è™•ç†
  const handleQuickLogin = async (account: any) => {
    setLoginLoading(true);
    const result = await apiService.login(account.originalUsername, account.password);
    
    if (result.success) {
      setAuthToken(result.data.token);
      setCurrentUser(result.data.user);
      setIsLoggedIn(true);
      // loadInitialData æœƒåœ¨ useEffect ä¸­è‡ªå‹•åŸ·è¡Œ
    } else {
      Alert.alert('å¿«é€Ÿç™»å…¥å¤±æ•—', result.message || 'ç™»å…¥å¤±æ•—');
    }
    setLoginLoading(false);
  };

  // è¼‰å…¥åˆå§‹è³‡æ–™ (ä¿®å¾©ç‰ˆ)
  const loadInitialData = async (token: string) => {
    if (!currentUser) return;
    
    setLoading(true);
    try {
      console.log('Loading initial data for user:', currentUser);
      
      const [materialsData, ordersData] = await Promise.all([
        apiService.getMaterials(token),
        loadOrdersByRole(token, currentUser.role)
      ]);
      
      console.log('Loaded materials:', materialsData.length);
      console.log('Loaded orders:', ordersData.length);
      
      setMaterials(materialsData);
      setOrders(ordersData);
    } catch (error) {
      console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
      Alert.alert('éŒ¯èª¤', 'è¼‰å…¥è³‡æ–™å¤±æ•—');
    } finally {
      setLoading(false);
    }
  };

  // æ ¹æ“šè§’è‰²è¼‰å…¥å°æ‡‰çš„è¨‚å–® (ä¿®å¾©ç‰ˆ)
  const loadOrdersByRole = async (token: string, userRole: string) => {
    console.log('Loading orders for role:', userRole);
    
    try {
      switch (userRole) {
        case 'PM':
          // PM åªçœ‹è¼”æè¨‚å–®ï¼Œä½†å…ˆå˜—è©¦æ‰€æœ‰è¨‚å–® API
          const pmOrders = await apiService.getAllOrders(token);
          return pmOrders.filter(order => 
            !order.type || order.type === 'AUXILIARY' || order.type === 'auxiliary'
          );
          
        case 'AM':
          // AM åªçœ‹å®Œæˆæè¨‚å–®ï¼Œä½†å…ˆå˜—è©¦æ‰€æœ‰è¨‚å–® API
          const amOrders = await apiService.getAllOrders(token);
          return amOrders.filter(order => 
            order.type === 'FINISHED' || order.type === 'finished'
          );
          
        case 'WAREHOUSE':
        case 'ADMIN':
          // å€‰ç®¡å’Œç®¡ç†å“¡çœ‹æ‰€æœ‰è¨‚å–®
          return await apiService.getAllOrders(token);
          
        default:
          return [];
      }
    } catch (error) {
      console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
      return [];
    }
  };

  // ç™»å‡º
  const handleLogout = () => {
    setIsLoggedIn(false);
    setAuthToken('');
    setCurrentUser(null);
    setCurrentPage('dashboard');
    setOrders([]);
    setMaterials([]);
  };

  // é–‹å•Ÿææ–™é¸æ“‡
  const handleOpenMaterialSelection = (type: string) => {
    setMaterialType(type);
    setSelectedMaterials([]);
    setShowMaterialSelection(true);
  };

  // é¸æ“‡ææ–™
  const handleSelectMaterial = (material: any) => {
    const existingIndex = selectedMaterials.findIndex(item => item.materialId === material.id);
    
    if (existingIndex >= 0) {
      const updated = [...selectedMaterials];
      updated[existingIndex].quantity += 1;
      setSelectedMaterials(updated);
    } else {
      setSelectedMaterials(prev => [...prev, {
        materialId: material.id,
        materialName: material.name,
        price: material.price,
        quantity: 1
      }]);
    }
  };

  // ç§»é™¤ææ–™
  const handleRemoveMaterial = (materialId: string) => {
    setSelectedMaterials(prev => prev.filter(item => item.materialId !== materialId));
  };

  // æ›´æ–°ææ–™æ•¸é‡
  const handleUpdateQuantity = (materialId: string, quantity: number) => {
    if (quantity <= 0) {
      handleRemoveMaterial(materialId);
      return;
    }
    
    setSelectedMaterials(prev => 
      prev.map(item => 
        item.materialId === materialId 
          ? { ...item, quantity } 
          : item
      )
    );
  };

  // å»ºç«‹è¨‚å–®
  const handleCreateOrder = async () => {
    if (selectedMaterials.length === 0) {
      Alert.alert('éŒ¯èª¤', 'è«‹é¸æ“‡ææ–™');
      return;
    }

    setLoading(true);
    
    const orderData = {
      items: selectedMaterials.map(item => ({
        materialId: item.materialId,
        quantity: item.quantity
      }))
    };

    let result;
    if (materialType === 'AUXILIARY') {
      result = await apiService.createAuxiliaryOrder(authToken, orderData);
    } else {
      result = await apiService.createFinishedOrder(authToken, orderData);
    }

    if (result.success) {
      Alert.alert('æˆåŠŸ', 'è¨‚å–®å»ºç«‹æˆåŠŸ');
      setShowMaterialSelection(false);
      setSelectedMaterials([]);
      // é‡æ–°è¼‰å…¥è³‡æ–™
      await loadInitialData(authToken);
    } else {
      Alert.alert('éŒ¯èª¤', result.error || 'å»ºç«‹è¨‚å–®å¤±æ•—');
    }
    setLoading(false);
  };

  // ç²å–è§’è‰²åŠŸèƒ½
  const getRoleFeatures = (role: string) => {
    const features = {
      PM: ['ğŸ”§ è¼”æè¨‚å–®ç®¡ç†'],
      AM: ['ğŸ  å®Œæˆæè¨‚å–®ç®¡ç†'],
      WAREHOUSE: ['ğŸ“‹ è¨‚å–®ç‹€æ…‹ç®¡ç†'],
      ADMIN: ['ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶å°', 'ğŸ”§ è¼”æè¨‚å–®ç®¡ç†', 'ğŸ  å®Œæˆæè¨‚å–®ç®¡ç†', 'ğŸ“‹ è¨‚å–®ç‹€æ…‹ç®¡ç†']
    };
    return features[role] || [];
  };

  // ç²å–è§’è‰²é¡¯ç¤ºæ–‡å­—
  const getRoleDisplayText = (role: string) => {
    const roleMap = {
      'ADMIN': 'ç³»çµ±ç®¡ç†å“¡',
      'PM': 'å°ˆæ¡ˆç¶“ç†',
      'AM': 'å€åŸŸç¶“ç†',
      'WAREHOUSE': 'å€‰ç®¡äººå“¡'
    };
    return roleMap[role] || role;
  };

  // ç²å–è§’è‰²é¡è‰²
  const getRoleColor = (role: string) => {
    const colorMap = {
      'ADMIN': '#dc3545',
      'PM': '#007bff',
      'AM': '#28a745',
      'WAREHOUSE': '#ffc107'
    };
    return colorMap[role] || '#6c757d';
  };

  // è¿”å›å„€è¡¨æ¿
  const handleBackToDashboard = () => {
    setCurrentPage('dashboard');
  };  // ç™»å…¥ç•«é¢

  if (!isLoggedIn) {
    return (
      <View style={[styles.loginContainer, { paddingTop: insets.top, paddingBottom: insets.bottom }]}>
        <ScrollView style={styles.loginScrollView}>
          <View style={styles.loginForm}>
            <Text style={styles.loginTitle}>ğŸ—ï¸ é›²æ°´åŸºæç®¡ç†ç³»çµ±</Text>
            <Text style={styles.loginSubtitle}>æ‰‹æ©Ÿç‰ˆç™»å…¥</Text>
            
            {/* å¿«é€Ÿç™»å…¥å€åŸŸ */}
            <View style={styles.quickLoginSection}>
              <Text style={styles.quickLoginTitle}>å¿«é€Ÿç™»å…¥</Text>
              <View style={styles.quickLoginGrid}>
                {quickLoginUsers.map((account) => (
                  <TouchableOpacity
                    key={account.id}
                    style={[styles.quickLoginButton, { borderColor: getRoleColor(account.role) }]}
                    onPress={() => handleQuickLogin(account)}
                    disabled={loginLoading}
                  >
                    <Text style={[styles.quickLoginName, { color: getRoleColor(account.role) }]}>
                      {account.username}
                    </Text>
                    <Text style={styles.quickLoginRole}>
                      {getRoleDisplayText(account.role)}
                    </Text>
                  </TouchableOpacity>
                ))}
              </View>
            </View>

            {/* åˆ†éš”ç·š */}
            <View style={styles.divider}>
              <View style={styles.dividerLine} />
              <Text style={styles.dividerText}>æˆ–</Text>
              <View style={styles.dividerLine} />
            </View>
            
            {/* æ‰‹å‹•ç™»å…¥å€åŸŸ */}
            <View style={styles.manualLoginSection}>
              <Text style={styles.manualLoginTitle}>æ‰‹å‹•ç™»å…¥</Text>
              <TextInput
                style={styles.loginInput}
                placeholder="å¸³è™Ÿ"
                value={loginForm.username}
                onChangeText={(text) => setLoginForm(prev => ({ ...prev, username: text }))}
                autoCapitalize="none"
              />
              
              <TextInput
                style={styles.loginInput}
                placeholder="å¯†ç¢¼"
                value={loginForm.password}
                onChangeText={(text) => setLoginForm(prev => ({ ...prev, password: text }))}
                secureTextEntry
              />
              
              <TouchableOpacity 
                style={styles.loginButton} 
                onPress={handleLogin}
                disabled={loginLoading}
              >
                {loginLoading ? (
                  <ActivityIndicator color="#fff" />
                ) : (
                  <Text style={styles.loginButtonText}>ç™»å…¥</Text>
                )}
              </TouchableOpacity>
            </View>
          </View>
        </ScrollView>
      </View>
    );
  }

  // å„€è¡¨æ¿
  const renderDashboard = () => (
    <ScrollView 
      style={styles.container}
      contentContainerStyle={{ paddingBottom: insets.bottom + 20 }}
    >
      <View style={styles.header}>
        <Text style={styles.title}>ğŸ—ï¸ é›²æ°´åŸºæç®¡ç†ç³»çµ±</Text>
        <Text style={styles.subtitle}>æ­¡è¿ï¼Œ{currentUser?.username}</Text>
        <Text style={styles.userRole}>è§’è‰²ï¼š{getRoleDisplayText(currentUser?.role)}</Text>
        <TouchableOpacity style={styles.logoutButton} onPress={handleLogout}>
          <Text style={styles.logoutText}>ç™»å‡º</Text>
        </TouchableOpacity>
      </View>
      
      <View style={styles.statsContainer}>
        <View style={styles.statCard}>
          <Text style={styles.statNumber}>{orders.length}</Text>
          <Text style={styles.statLabel}>ç¸½è¨‚å–®æ•¸</Text>
        </View>
        <View style={styles.statCard}>
          <Text style={styles.statNumber}>{materials.length}</Text>
          <Text style={styles.statLabel}>åŸºæç¨®é¡</Text>
        </View>
      </View>

      <View style={styles.featuresSection}>
        <Text style={styles.featuresTitle}>ç³»çµ±åŠŸèƒ½</Text>
        <View style={styles.featuresGrid}>
          {getRoleFeatures(currentUser?.role).map((feature, index) => (
            <TouchableOpacity
              key={index}
              style={styles.featureCard}
              onPress={() => {
                if (feature.includes('è¼”æè¨‚å–®ç®¡ç†')) {
                  setCurrentPage('auxiliary-orders');
                } else if (feature.includes('å®Œæˆæè¨‚å–®ç®¡ç†')) {
                  setCurrentPage('finished-orders');
                } else if (feature.includes('è¨‚å–®ç‹€æ…‹ç®¡ç†')) {
                  setCurrentPage('order-status');
                } else if (feature.includes('ç®¡ç†å“¡æ§åˆ¶å°')) {
                  setCurrentPage('admin-dashboard');
                }
              }}
            >
              <Text style={styles.featureText}>{feature}</Text>
            </TouchableOpacity>
          ))}
        </View>
      </View>
    </ScrollView>
  );

  // è¼”æè¨‚å–®ç®¡ç†
  const renderAuxiliaryOrders = () => (
    <View style={styles.pageContainer}>
      <View style={styles.pageHeader}>
        <TouchableOpacity style={styles.backHeaderButton} onPress={handleBackToDashboard}>
          <Text style={styles.backHeaderText}>â† è¿”å›</Text>
        </TouchableOpacity>
        <Text style={styles.pageTitle}>ğŸ”§ è¼”æè¨‚å–®ç®¡ç†</Text>
        <TouchableOpacity 
          style={styles.addButton} 
          onPress={() => handleOpenMaterialSelection('AUXILIARY')}
        >
          <Text style={styles.addButtonText}>+ é¸æ“‡è¼”æ</Text>
        </TouchableOpacity>
      </View>
      
      <ScrollView 
        style={styles.pageContent}
        contentContainerStyle={{ paddingBottom: insets.bottom + 20 }}
      >
        {loading ? (
          <View style={styles.loadingContainer}>
            <ActivityIndicator size="large" color="#007bff" />
            <Text style={styles.loadingText}>è¼‰å…¥è¨‚å–®ä¸­...</Text>
          </View>
        ) : orders.filter(order => !order.type || order.type === 'AUXILIARY' || order.type === 'auxiliary').length === 0 ? (
          <View style={styles.emptyContainer}>
            <Text style={styles.emptyText}>æš«ç„¡è¼”æè¨‚å–®</Text>
            <Text style={styles.emptyHint}>é»æ“Šä¸Šæ–¹ã€Œ+ é¸æ“‡è¼”æã€å»ºç«‹æ–°è¨‚å–®</Text>
          </View>
        ) : (
          orders.filter(order => !order.type || order.type === 'AUXILIARY' || order.type === 'auxiliary').map((order, index) => (
            <View key={order.id || index} style={styles.orderCard}>
              <Text style={styles.orderNumber}>è¨‚å–® #{order.orderNumber || order.id}</Text>
              <Text style={styles.orderDate}>æ—¥æœŸ: {order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'æœªçŸ¥'}</Text>
              <Text style={styles.orderStatus}>ç‹€æ…‹: {order.status || 'å¾…è™•ç†'}</Text>
              
              {order.items && order.items.length > 0 && (
                <View style={styles.orderItems}>
                  <Text style={styles.orderItemsTitle}>è¨‚å–®é …ç›®:</Text>
                  {order.items.map((item, itemIndex) => (
                    <Text key={itemIndex} style={styles.orderItem}>
                      â€¢ {item.materialName || item.name} x {item.quantity}
                    </Text>
                  ))}
                </View>
              )}
            </View>
          ))
        )}
      </ScrollView>
    </View>
  );

  // å®Œæˆæè¨‚å–®ç®¡ç†
  const renderFinishedOrders = () => (
    <View style={styles.pageContainer}>
      <View style={styles.pageHeader}>
        <TouchableOpacity style={styles.backHeaderButton} onPress={handleBackToDashboard}>
          <Text style={styles.backHeaderText}>â† è¿”å›</Text>
        </TouchableOpacity>
        <Text style={styles.pageTitle}>ğŸ  å®Œæˆæè¨‚å–®ç®¡ç†</Text>
        <TouchableOpacity 
          style={styles.addButton} 
          onPress={() => handleOpenMaterialSelection('FINISHED')}
        >
          <Text style={styles.addButtonText}>+ é¸æ“‡å®Œæˆæ</Text>
        </TouchableOpacity>
      </View>
      
      <ScrollView 
        style={styles.pageContent}
        contentContainerStyle={{ paddingBottom: insets.bottom + 20 }}
      >
        {loading ? (
          <View style={styles.loadingContainer}>
            <ActivityIndicator size="large" color="#007bff" />
            <Text style={styles.loadingText}>è¼‰å…¥è¨‚å–®ä¸­...</Text>
          </View>
        ) : orders.filter(order => order.type === 'FINISHED' || order.type === 'finished').length === 0 ? (
          <View style={styles.emptyContainer}>
            <Text style={styles.emptyText}>æš«ç„¡å®Œæˆæè¨‚å–®</Text>
            <Text style={styles.emptyHint}>é»æ“Šä¸Šæ–¹ã€Œ+ é¸æ“‡å®Œæˆæã€å»ºç«‹æ–°è¨‚å–®</Text>
          </View>
        ) : (
          orders.filter(order => order.type === 'FINISHED' || order.type === 'finished').map((order, index) => (
            <View key={order.id || index} style={styles.orderCard}>
              <Text style={styles.orderNumber}>è¨‚å–® #{order.orderNumber || order.id}</Text>
              <Text style={styles.orderDate}>æ—¥æœŸ: {order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'æœªçŸ¥'}</Text>
              <Text style={styles.orderStatus}>ç‹€æ…‹: {order.status || 'å¾…è™•ç†'}</Text>
              
              {order.items && order.items.length > 0 && (
                <View style={styles.orderItems}>
                  <Text style={styles.orderItemsTitle}>è¨‚å–®é …ç›®:</Text>
                  {order.items.map((item, itemIndex) => (
                    <Text key={itemIndex} style={styles.orderItem}>
                      â€¢ {item.materialName || item.name} x {item.quantity}
                    </Text>
                  ))}
                </View>
              )}
            </View>
          ))
        )}
      </ScrollView>
    </View>
  );

  // è¨‚å–®ç‹€æ…‹ç®¡ç†
  const renderOrderStatus = () => (
    <View style={styles.pageContainer}>
      <View style={styles.pageHeader}>
        <TouchableOpacity style={styles.backHeaderButton} onPress={handleBackToDashboard}>
          <Text style={styles.backHeaderText}>â† è¿”å›</Text>
        </TouchableOpacity>
        <Text style={styles.pageTitle}>ğŸ“‹ è¨‚å–®ç‹€æ…‹ç®¡ç†</Text>
        <View style={styles.headerSpacer} />
      </View>
      
      <ScrollView 
        style={styles.pageContent}
        contentContainerStyle={{ paddingBottom: insets.bottom + 20 }}
      >
        {loading ? (
          <View style={styles.loadingContainer}>
            <ActivityIndicator size="large" color="#007bff" />
            <Text style={styles.loadingText}>è¼‰å…¥è¨‚å–®ä¸­...</Text>
          </View>
        ) : orders.length === 0 ? (
          <View style={styles.emptyContainer}>
            <Text style={styles.emptyText}>æš«ç„¡è¨‚å–®éœ€è¦ç®¡ç†</Text>
          </View>
        ) : (
          orders.map((order, index) => (
            <View key={order.id || index} style={styles.statusCard}>
              <Text style={styles.orderNumber}>è¨‚å–® #{order.orderNumber || order.id}</Text>
              <Text style={styles.orderType}>é¡å‹: {order.type === 'FINISHED' || order.type === 'finished' ? 'å®Œæˆæ' : 'è¼”æ'}</Text>
              <Text style={styles.orderDate}>æ—¥æœŸ: {order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'æœªçŸ¥'}</Text>
              
              <View style={styles.statusSection}>
                <Text style={styles.statusTitle}>è¨‚å–®ç‹€æ…‹:</Text>
                <Text style={styles.statusValue}>{order.status || 'å¾…è™•ç†'}</Text>
              </View>
            </View>
          ))
        )}
      </ScrollView>
    </View>
  );

  return (
    <View style={[styles.app, { paddingTop: insets.top }]}>
      {currentPage === 'dashboard' && renderDashboard()}
      {currentPage === 'auxiliary-orders' && renderAuxiliaryOrders()}
      {currentPage === 'finished-orders' && renderFinishedOrders()}
      {currentPage === 'order-status' && renderOrderStatus()}
      
      {/* ææ–™é¸æ“‡ Modal */}
      <Modal visible={showMaterialSelection} animationType="slide" transparent>
        <View style={styles.modalOverlay}>
          <View style={[styles.modalContent, { paddingBottom: insets.bottom + 20 }]}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>
                é¸æ“‡{materialType === 'AUXILIARY' ? 'è¼”æ' : 'å®Œæˆæ'}
              </Text>
              <TouchableOpacity onPress={() => setShowMaterialSelection(false)}>
                <Text style={styles.closeButton}>âœ•</Text>
              </TouchableOpacity>
            </View>
            
            <ScrollView style={styles.materialsList}>
              {materials
                .filter(material => material.type === materialType)
                .map((material, index) => (
                <TouchableOpacity
                  key={material.id || index}
                  style={styles.materialSelectCard}
                  onPress={() => handleSelectMaterial(material)}
                >
                  <Text style={styles.materialSelectName}>{material.name}</Text>
                  <Text style={styles.materialSelectPrice}>CAD ${material.price}</Text>
                  <Text style={styles.materialSelectStock}>åº«å­˜: {material.quantity}</Text>
                </TouchableOpacity>
              ))}
            </ScrollView>
            
            {/* è³¼ç‰©è»Š */}
            <View style={styles.cart}>
              <Text style={styles.cartTitle}>å·²é¸æ“‡çš„ææ–™ ({selectedMaterials.length})</Text>
              {selectedMaterials.map((item, index) => (
                <View key={index} style={styles.cartItem}>
                  <Text style={styles.cartItemName}>{item.materialName}</Text>
                  <View style={styles.quantityControls}>
                    <TouchableOpacity 
                      style={styles.quantityButton}
                      onPress={() => handleUpdateQuantity(item.materialId, item.quantity - 1)}
                    >
                      <Text style={styles.quantityButtonText}>-</Text>
                    </TouchableOpacity>
                    <Text style={styles.quantityText}>{item.quantity}</Text>
                    <TouchableOpacity 
                      style={styles.quantityButton}
                      onPress={() => handleUpdateQuantity(item.materialId, item.quantity + 1)}
                    >
                      <Text style={styles.quantityButtonText}>+</Text>
                    </TouchableOpacity>
                  </View>
                </View>
              ))}
            </View>
            
            <View style={styles.modalButtons}>
              <TouchableOpacity 
                style={styles.cancelButton} 
                onPress={() => setShowMaterialSelection(false)}
              >
                <Text style={styles.cancelText}>å–æ¶ˆ</Text>
              </TouchableOpacity>
              <TouchableOpacity 
                style={[styles.createOrderButton, selectedMaterials.length === 0 && styles.disabledButton]} 
                onPress={handleCreateOrder}
                disabled={selectedMaterials.length === 0}
              >
                <Text style={styles.createOrderText}>å»ºç«‹è¨‚å–®</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {loading && (
        <View style={styles.loadingOverlay}>
          <ActivityIndicator size="large" color="#007bff" />
          <Text style={styles.loadingText}>è™•ç†ä¸­...</Text>
        </View>
      )}
    </View>
  );
}const st
yles = StyleSheet.create({
  app: { flex: 1, backgroundColor: '#f5f5f5' },
  
  // ç™»å…¥ç›¸é—œ
  loginContainer: { flex: 1, backgroundColor: '#007bff' },
  loginScrollView: { flex: 1, padding: 20 },
  loginForm: { backgroundColor: '#fff', padding: 30, borderRadius: 15, marginTop: 20 },
  loginTitle: { fontSize: 24, fontWeight: 'bold', textAlign: 'center', marginBottom: 10, color: '#007bff' },
  loginSubtitle: { fontSize: 16, textAlign: 'center', marginBottom: 30, color: '#666' },
  
  // å¿«é€Ÿç™»å…¥
  quickLoginSection: { marginBottom: 20 },
  quickLoginTitle: { fontSize: 18, fontWeight: 'bold', textAlign: 'center', marginBottom: 15, color: '#333' },
  quickLoginGrid: { flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'space-between' },
  quickLoginButton: { 
    width: '48%', 
    backgroundColor: '#fff', 
    borderWidth: 2, 
    borderRadius: 10, 
    padding: 15, 
    marginBottom: 10, 
    alignItems: 'center',
    elevation: 2
  },
  quickLoginName: { fontSize: 16, fontWeight: 'bold', marginBottom: 5 },
  quickLoginRole: { fontSize: 12, color: '#666' },
  
  // åˆ†éš”ç·š
  divider: { flexDirection: 'row', alignItems: 'center', marginVertical: 20 },
  dividerLine: { flex: 1, height: 1, backgroundColor: '#ddd' },
  dividerText: { marginHorizontal: 15, color: '#666', fontSize: 14 },
  
  // æ‰‹å‹•ç™»å…¥
  manualLoginSection: {},
  manualLoginTitle: { fontSize: 16, fontWeight: 'bold', textAlign: 'center', marginBottom: 15, color: '#333' },
  loginInput: { borderWidth: 1, borderColor: '#ddd', borderRadius: 8, padding: 15, marginBottom: 15, fontSize: 16 },
  loginButton: { backgroundColor: '#007bff', padding: 15, borderRadius: 8, alignItems: 'center' },
  loginButtonText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  
  // ä¸»è¦ä½ˆå±€
  container: { flex: 1, padding: 20 },
  header: { alignItems: 'center', marginBottom: 30 },
  title: { fontSize: 24, fontWeight: 'bold', color: '#007bff', marginBottom: 5 },
  subtitle: { fontSize: 16, color: '#666', marginBottom: 5 },
  userRole: { fontSize: 14, color: '#28a745', marginBottom: 10 },
  logoutButton: { backgroundColor: '#dc3545', paddingHorizontal: 15, paddingVertical: 8, borderRadius: 5 },
  logoutText: { color: '#fff', fontSize: 14 },
  
  // çµ±è¨ˆå¡ç‰‡
  statsContainer: { flexDirection: 'row', justifyContent: 'space-around', marginBottom: 30 },
  statCard: { backgroundColor: '#fff', padding: 20, borderRadius: 10, alignItems: 'center', minWidth: 120, elevation: 3 },
  statNumber: { fontSize: 32, fontWeight: 'bold', color: '#007bff' },
  statLabel: { fontSize: 14, color: '#666', marginTop: 5 },
  
  // åŠŸèƒ½å€åŸŸ
  featuresSection: { marginBottom: 20 },
  featuresTitle: { fontSize: 20, fontWeight: 'bold', color: '#333', marginBottom: 15 },
  featuresGrid: { gap: 15 },
  featureCard: { backgroundColor: '#fff', padding: 20, borderRadius: 10, alignItems: 'center', elevation: 2 },
  featureText: { fontSize: 16, fontWeight: 'bold', color: '#007bff' },
  
  // é é¢ä½ˆå±€ (ä¿®å¾©ç‰ˆ)
  pageContainer: { flex: 1 },
  pageHeader: { 
    flexDirection: 'row', 
    justifyContent: 'space-between', 
    alignItems: 'center', 
    paddingHorizontal: 20, 
    paddingVertical: 15,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
    elevation: 2
  },
  pageContent: { flex: 1, padding: 20 },
  pageTitle: { fontSize: 18, fontWeight: 'bold', color: '#007bff', flex: 1, textAlign: 'center' },
  
  // è¿”å›æŒ‰éˆ• (é ‚éƒ¨)
  backHeaderButton: { 
    backgroundColor: '#6c757d', 
    paddingHorizontal: 12, 
    paddingVertical: 8, 
    borderRadius: 6,
    minWidth: 60
  },
  backHeaderText: { color: '#fff', fontSize: 14, fontWeight: 'bold' },
  headerSpacer: { minWidth: 60 }, // ä½”ä½ç¬¦ï¼Œä¿æŒæ¨™é¡Œå±…ä¸­
  
  // æ–°å¢æŒ‰éˆ•
  addButton: { backgroundColor: '#28a745', paddingHorizontal: 12, paddingVertical: 8, borderRadius: 6, minWidth: 60 },
  addButtonText: { color: '#fff', fontSize: 12, fontWeight: 'bold', textAlign: 'center' },
  
  // è¼‰å…¥å’Œç©ºç‹€æ…‹
  loadingContainer: { alignItems: 'center', marginVertical: 40 },
  loadingText: { marginTop: 10, fontSize: 16, color: '#666' },
  emptyContainer: { alignItems: 'center', marginVertical: 40 },
  emptyText: { fontSize: 16, color: '#666', marginBottom: 10 },
  emptyHint: { fontSize: 14, color: '#999', textAlign: 'center' },
  
  // è¨‚å–®å¡ç‰‡
  orderCard: { backgroundColor: '#fff', padding: 15, borderRadius: 10, marginBottom: 15, elevation: 2 },
  orderNumber: { fontSize: 16, fontWeight: 'bold', color: '#333', marginBottom: 5 },
  orderDate: { fontSize: 12, color: '#999', marginBottom: 5 },
  orderStatus: { fontSize: 14, color: '#ffc107', marginBottom: 10 },
  orderItems: { borderTopWidth: 1, borderTopColor: '#eee', paddingTop: 10 },
  orderItemsTitle: { fontSize: 14, fontWeight: 'bold', color: '#333', marginBottom: 5 },
  orderItem: { fontSize: 13, color: '#666', marginBottom: 2 },
  
  // ç‹€æ…‹å¡ç‰‡
  statusCard: { backgroundColor: '#fff', padding: 15, borderRadius: 10, marginBottom: 15, elevation: 2 },
  orderType: { fontSize: 14, color: '#007bff', marginBottom: 5 },
  statusSection: { marginTop: 10 },
  statusTitle: { fontSize: 14, fontWeight: 'bold', color: '#333' },
  statusValue: { fontSize: 14, color: '#28a745', marginTop: 5 },
  
  // Modal
  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', alignItems: 'center' },
  modalContent: { backgroundColor: '#fff', borderRadius: 15, width: '95%', height: '80%', padding: 20 },
  modalHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 },
  modalTitle: { fontSize: 20, fontWeight: 'bold', color: '#333' },
  closeButton: { fontSize: 24, color: '#666' },
  
  // ææ–™åˆ—è¡¨
  materialsList: { flex: 1, marginBottom: 20 },
  materialSelectCard: { backgroundColor: '#f8f9fa', padding: 15, borderRadius: 8, marginBottom: 10 },
  materialSelectName: { fontSize: 16, fontWeight: 'bold', color: '#333', marginBottom: 5 },
  materialSelectPrice: { fontSize: 14, color: '#28a745', marginBottom: 3 },
  materialSelectStock: { fontSize: 12, color: '#666' },
  
  // è³¼ç‰©è»Š
  cart: { borderTopWidth: 1, borderTopColor: '#eee', paddingTop: 15, marginBottom: 20 },
  cartTitle: { fontSize: 16, fontWeight: 'bold', color: '#333', marginBottom: 10 },
  cartItem: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', paddingVertical: 8 },
  cartItemName: { flex: 1, fontSize: 14, color: '#333' },
  quantityControls: { flexDirection: 'row', alignItems: 'center' },
  quantityButton: { backgroundColor: '#007bff', width: 30, height: 30, borderRadius: 15, justifyContent: 'center', alignItems: 'center' },
  quantityButtonText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  quantityText: { marginHorizontal: 15, fontSize: 16, fontWeight: 'bold' },
  
  // æŒ‰éˆ•
  modalButtons: { flexDirection: 'row', gap: 10 },
  cancelButton: { flex: 1, backgroundColor: '#6c757d', padding: 12, borderRadius: 8, alignItems: 'center' },
  cancelText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  createOrderButton: { flex: 1, backgroundColor: '#28a745', padding: 12, borderRadius: 8, alignItems: 'center' },
  createOrderText: { color: '#fff', fontSize: 16, fontWeight: 'bold' },
  disabledButton: { backgroundColor: '#ccc' },
  
  // è¼‰å…¥è¦†è“‹å±¤
  loadingOverlay: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', alignItems: 'center' },
});