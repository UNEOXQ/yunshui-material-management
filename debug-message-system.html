<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€ç³»çµ±èª¿è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .user-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .user-card h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        .user-card p {
            margin: 5px 0;
            font-size: 14px;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            font-size: 14px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ” ç•™è¨€ç³»çµ±èª¿è©¦å·¥å…·</h1>
        
        <div class="step">
            <h3>æ­¥é©Ÿ 1: æª¢æŸ¥å¾Œç«¯é€£æ¥</h3>
            <button onclick="checkBackend()">æª¢æŸ¥å¾Œç«¯ç‹€æ…‹</button>
            <div id="backendResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 2: ç®¡ç†å“¡ç™»å…¥</h3>
            <button onclick="loginAdmin()">ç™»å…¥ç®¡ç†å“¡</button>
            <div id="loginResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 3: ç²å–æ‰€æœ‰ç”¨æˆ¶</h3>
            <button onclick="getAllUsers()">ç²å–ç”¨æˆ¶åˆ—è¡¨</button>
            <div id="usersResult"></div>
            <div id="usersList"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 4: ç™¼é€æ¸¬è©¦ç•™è¨€</h3>
            <div>
                <label>é¸æ“‡ç›®æ¨™ç”¨æˆ¶ï¼š</label>
                <select id="targetUser">
                    <option value="">-- è«‹å…ˆç²å–ç”¨æˆ¶åˆ—è¡¨ --</option>
                </select>
            </div>
            <div style="margin: 10px 0;">
                <label>ç•™è¨€å…§å®¹ï¼š</label><br>
                <textarea id="messageContent" rows="3" placeholder="è¼¸å…¥è¦ç™¼é€çš„ç•™è¨€å…§å®¹...">æ¸¬è©¦ç•™è¨€ï¼šé€™æ˜¯ä¸€æ¢ä¾†è‡ªç®¡ç†å“¡çš„æ¸¬è©¦è¨Šæ¯ - ${new Date().toLocaleString()}</textarea>
            </div>
            <button onclick="sendTestMessage()">ç™¼é€ç•™è¨€</button>
            <div id="sendResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 5: æª¢æŸ¥ç•™è¨€ç‹€æ…‹</h3>
            <button onclick="checkAllMessages()">æª¢æŸ¥æ‰€æœ‰ç•™è¨€</button>
            <button onclick="checkUnreadMessages()">æª¢æŸ¥æœªè®€ç•™è¨€</button>
            <div id="messagesResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 6: ç”¨æˆ¶ç™»å…¥æ¸¬è©¦</h3>
            <div>
                <label>é¸æ“‡ç”¨æˆ¶ï¼š</label>
                <select id="testUser">
                    <option value="">-- è«‹å…ˆç²å–ç”¨æˆ¶åˆ—è¡¨ --</option>
                </select>
                <button onclick="loginTestUser()">ç™»å…¥é¸ä¸­ç”¨æˆ¶</button>
            </div>
            <div id="userLoginResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 7: å‰ç«¯çµ„ä»¶æ¸¬è©¦</h3>
            <button onclick="testFrontendComponent()">æ¸¬è©¦å‰ç«¯ç•™è¨€çµ„ä»¶</button>
            <div id="frontendResult"></div>
        </div>
    </div>

    <script>
        let adminToken = '';
        let userToken = '';
        let allUsers = [];

        async function checkBackend() {
            try {
                const response = await fetch('http://localhost:3004/health');
                const result = await response.json();
                
                document.getElementById('backendResult').innerHTML = 
                    '<div class="step success">âœ… å¾Œç«¯é€£æ¥æ­£å¸¸<pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
            } catch (error) {
                document.getElementById('backendResult').innerHTML = 
                    '<div class="step error">âŒ å¾Œç«¯é€£æ¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function loginAdmin() {
            try {
                const response = await fetch('http://localhost:3004/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                const result = await response.json();
                
                if (result.success) {
                    adminToken = result.data.token;
                    document.getElementById('loginResult').innerHTML = 
                        '<div class="step success">âœ… ç®¡ç†å“¡ç™»å…¥æˆåŠŸ<pre>' + JSON.stringify(result.data.user, null, 2) + '</pre></div>';
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        '<div class="step error">âŒ ç™»å…¥å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    '<div class="step error">âŒ ç™»å…¥è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function getAllUsers() {
            if (!adminToken) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
                return;
            }

            try {
                const response = await fetch('http://localhost:3004/api/users', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const result = await response.json();
                
                if (result.success && result.data.users) {
                    allUsers = result.data.users;
                    
                    // æ›´æ–°ç”¨æˆ¶é¸æ“‡ä¸‹æ‹‰æ¡†
                    const targetSelect = document.getElementById('targetUser');
                    const testSelect = document.getElementById('testUser');
                    
                    targetSelect.innerHTML = '<option value="">-- é¸æ“‡ç›®æ¨™ç”¨æˆ¶ --</option>';
                    testSelect.innerHTML = '<option value="">-- é¸æ“‡æ¸¬è©¦ç”¨æˆ¶ --</option>';
                    
                    allUsers.forEach(user => {
                        if (user.role !== 'ADMIN') {
                            const option1 = new Option(`${user.username} (${user.role})`, user.id);
                            const option2 = new Option(`${user.username} (${user.role})`, user.id);
                            targetSelect.add(option1);
                            testSelect.add(option2);
                        }
                    });
                    
                    // é¡¯ç¤ºç”¨æˆ¶å¡ç‰‡
                    const userCards = allUsers.map(user => `
                        <div class="user-card">
                            <h4>${user.username}</h4>
                            <p><strong>ID:</strong> ${user.id}</p>
                            <p><strong>è§’è‰²:</strong> ${user.role}</p>
                            <p><strong>éƒµç®±:</strong> ${user.email}</p>
                        </div>
                    `).join('');
                    
                    document.getElementById('usersResult').innerHTML = 
                        '<div class="step success">âœ… ç”¨æˆ¶åˆ—è¡¨ç²å–æˆåŠŸ</div>';
                    document.getElementById('usersList').innerHTML = 
                        '<div class="user-grid">' + userCards + '</div>';
                } else {
                    document.getElementById('usersResult').innerHTML = 
                        '<div class="step error">âŒ ç²å–ç”¨æˆ¶åˆ—è¡¨å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('usersResult').innerHTML = 
                    '<div class="step error">âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function sendTestMessage() {
            if (!adminToken) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
                return;
            }

            const targetUserId = document.getElementById('targetUser').value;
            const content = document.getElementById('messageContent').value;

            if (!targetUserId) {
                alert('è«‹é¸æ“‡ç›®æ¨™ç”¨æˆ¶');
                return;
            }

            if (!content.trim()) {
                alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
                return;
            }

            try {
                const response = await fetch('http://localhost:3004/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        toUserId: targetUserId,
                        content: content.trim()
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('sendResult').innerHTML = 
                        '<div class="step success">âœ… ç•™è¨€ç™¼é€æˆåŠŸ<pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
                } else {
                    document.getElementById('sendResult').innerHTML = 
                        '<div class="step error">âŒ ç™¼é€å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('sendResult').innerHTML = 
                    '<div class="step error">âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function checkAllMessages() {
            if (!adminToken) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
                return;
            }

            try {
                // é€™è£¡æˆ‘å€‘éœ€è¦æª¢æŸ¥æ•¸æ“šåº«ä¸­çš„æ‰€æœ‰ç•™è¨€
                // ç”±æ–¼æ²’æœ‰ç›´æ¥çš„APIï¼Œæˆ‘å€‘é€šéæª¢æŸ¥æ¯å€‹ç”¨æˆ¶çš„æœªè®€ç•™è¨€ä¾†äº†è§£æƒ…æ³
                let allMessages = [];
                
                for (const user of allUsers) {
                    try {
                        // å…ˆç™»å…¥è©²ç”¨æˆ¶
                        const loginResponse = await fetch('http://localhost:3004/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: user.username === 'ç®¡ç†' ? 'admin' : 
                                         user.username === 'é¦¬å…‹' ? 'warehouse001' : user.username,
                                password: user.role === 'ADMIN' ? 'admin123' :
                                         user.role === 'PM' ? 'pm123' :
                                         user.role === 'AM' ? 'am123' : 'wh123'
                            })
                        });
                        
                        if (loginResponse.ok) {
                            const loginResult = await loginResponse.json();
                            if (loginResult.success) {
                                // ç²å–è©²ç”¨æˆ¶çš„æœªè®€ç•™è¨€
                                const messagesResponse = await fetch('http://localhost:3004/api/messages/unread', {
                                    headers: { 'Authorization': `Bearer ${loginResult.data.token}` }
                                });
                                
                                if (messagesResponse.ok) {
                                    const messagesResult = await messagesResponse.json();
                                    if (messagesResult.success && messagesResult.data) {
                                        messagesResult.data.forEach(msg => {
                                            allMessages.push({
                                                ...msg,
                                                receiverUsername: user.username
                                            });
                                        });
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.log(`æª¢æŸ¥ç”¨æˆ¶ ${user.username} çš„ç•™è¨€æ™‚å‡ºéŒ¯:`, e);
                    }
                }
                
                document.getElementById('messagesResult').innerHTML = 
                    '<div class="step success">âœ… æ‰¾åˆ° ' + allMessages.length + ' æ¢ç•™è¨€<pre>' + 
                    JSON.stringify(allMessages, null, 2) + '</pre></div>';
                    
            } catch (error) {
                document.getElementById('messagesResult').innerHTML = 
                    '<div class="step error">âŒ æª¢æŸ¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function checkUnreadMessages() {
            if (!userToken) {
                alert('è«‹å…ˆç™»å…¥ä¸€å€‹æ¸¬è©¦ç”¨æˆ¶');
                return;
            }

            try {
                const response = await fetch('http://localhost:3004/api/messages/unread', {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });

                const result = await response.json();
                
                document.getElementById('messagesResult').innerHTML = 
                    '<div class="step success">âœ… æœªè®€ç•™è¨€æª¢æŸ¥å®Œæˆ<pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
            } catch (error) {
                document.getElementById('messagesResult').innerHTML = 
                    '<div class="step error">âŒ æª¢æŸ¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function loginTestUser() {
            const userId = document.getElementById('testUser').value;
            if (!userId) {
                alert('è«‹é¸æ“‡ä¸€å€‹ç”¨æˆ¶');
                return;
            }

            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                alert('ç”¨æˆ¶ä¸å­˜åœ¨');
                return;
            }

            try {
                const username = user.username === 'ç®¡ç†' ? 'admin' : 
                               user.username === 'é¦¬å…‹' ? 'warehouse001' : user.username;
                const password = user.role === 'ADMIN' ? 'admin123' :
                               user.role === 'PM' ? 'pm123' :
                               user.role === 'AM' ? 'am123' : 'wh123';

                const response = await fetch('http://localhost:3004/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    userToken = result.data.token;
                    document.getElementById('userLoginResult').innerHTML = 
                        '<div class="step success">âœ… ç”¨æˆ¶ç™»å…¥æˆåŠŸï¼š' + user.username + 
                        '<pre>' + JSON.stringify(result.data.user, null, 2) + '</pre></div>';
                } else {
                    document.getElementById('userLoginResult').innerHTML = 
                        '<div class="step error">âŒ ç”¨æˆ¶ç™»å…¥å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('userLoginResult').innerHTML = 
                    '<div class="step error">âŒ ç™»å…¥è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        function testFrontendComponent() {
            document.getElementById('frontendResult').innerHTML = 
                '<div class="step warning">âš ï¸ å‰ç«¯çµ„ä»¶æ¸¬è©¦éœ€è¦åœ¨å¯¦éš›ç³»çµ±ä¸­é€²è¡Œ<br>' +
                'è«‹æ‰“é–‹ <a href="http://localhost:5173" target="_blank">http://localhost:5173</a> ä¸¦ç™»å…¥ç›¸æ‡‰ç”¨æˆ¶æŸ¥çœ‹ç•™è¨€å°å·¥å…·</div>';
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥å¾Œç«¯
        window.onload = function() {
            checkBackend();
        };
    </script>
</body>
</html>