<!DOCTYPE html>
<html>
<head>
    <title>圖片上傳測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        img { max-width: 200px; margin: 10px; border: 1px solid #ddd; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>圖片上傳和顯示測試</h1>
    
    <div class="section">
        <h3>1. 測試靜態文件訪問</h3>
        <button onclick="testStaticAccess()">測試靜態文件</button>
        <div id="static-result"></div>
    </div>
    
    <div class="section">
        <h3>2. 測試圖片上傳（需要管理員權限）</h3>
        <input type="file" id="imageFile" accept="image/*">
        <button onclick="testImageUpload()">上傳圖片</button>
        <div id="upload-result"></div>
    </div>
    
    <div class="section">
        <h3>3. 測試圖片顯示</h3>
        <button onclick="testImageDisplay()">測試圖片顯示</button>
        <div id="display-result"></div>
    </div>
    
    <script>
        const baseUrl = 'https://yunshui-material-management.onrender.com';
        
        // 測試靜態文件訪問
        async function testStaticAccess() {
            const resultDiv = document.getElementById('static-result');
            resultDiv.innerHTML = '測試中...';
            
            try {
                // 測試 uploads 目錄
                const response = await fetch(`${baseUrl}/uploads/`);
                resultDiv.innerHTML = `
                    <div class="success">✅ /uploads/ 可訪問 (狀態: ${response.status})</div>
                `;
                
                // 測試 materials 子目錄
                const materialsResponse = await fetch(`${baseUrl}/uploads/materials/`);
                resultDiv.innerHTML += `
                    <div class="success">✅ /uploads/materials/ 可訪問 (狀態: ${materialsResponse.status})</div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ 靜態文件訪問失敗: ${error.message}</div>
                `;
            }
        }
        
        // 測試圖片上傳
        async function testImageUpload() {
            const resultDiv = document.getElementById('upload-result');
            const fileInput = document.getElementById('imageFile');
            
            if (!fileInput.files || !fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">請先選擇一個圖片文件</div>';
                return;
            }
            
            resultDiv.innerHTML = '上傳中...';
            
            try {
                // 首先需要登入獲取 token（這裡使用測試帳號）
                const loginResponse = await fetch(`${baseUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('登入失敗，需要管理員權限');
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.data.token;
                
                // 創建一個測試材料（如果需要）
                const materialResponse = await fetch(`${baseUrl}/api/materials`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name: '測試材料-圖片上傳',
                        category: '測試分類',
                        type: 'AUXILIARY',
                        price: 100,
                        quantity: 10,
                        supplier: '測試供應商'
                    })
                });
                
                const materialData = await materialResponse.json();
                const materialId = materialData.data.id;
                
                // 上傳圖片
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                
                const uploadResponse = await fetch(`${baseUrl}/api/upload/material/${materialId}/image`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (uploadResponse.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">✅ 圖片上傳成功！</div>
                        <div class="info">材料 ID: ${materialId}</div>
                        <div class="info">圖片 URL: ${uploadData.data.imageUrl}</div>
                        <img src="${uploadData.data.imageUrl}" alt="上傳的圖片">
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">❌ 圖片上傳失敗: ${uploadData.message}</div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">❌ 上傳過程出錯: ${error.message}</div>
                `;
            }
        }
        
        // 測試圖片顯示
        async function testImageDisplay() {
            const resultDiv = document.getElementById('display-result');
            resultDiv.innerHTML = '測試中...';
            
            // 測試一些可能的圖片 URL
            const testUrls = [
                `${baseUrl}/uploads/materials/test.jpg`,
                `${baseUrl}/uploads/materials/sample.png`,
                `${baseUrl}/uploads/test.jpg`
            ];
            
            let html = '<h4>測試圖片 URL:</h4>';
            
            testUrls.forEach((url, index) => {
                html += `
                    <div style="margin: 10px 0;">
                        <p>URL ${index + 1}: <a href="${url}" target="_blank">${url}</a></p>
                        <img src="${url}" alt="測試圖片 ${index + 1}" 
                             onload="this.nextElementSibling.innerHTML='<span class=\\"success\\">✅ 載入成功</span>'"
                             onerror="this.nextElementSibling.innerHTML='<span class=\\"error\\">❌ 載入失敗</span>'"
                             style="max-width: 100px; display: block;">
                        <div></div>
                    </div>
                `;
            });
            
            resultDiv.innerHTML = html;
        }
        
        // 頁面載入時自動測試靜態文件
        testStaticAccess();
    </script>
</body>
</html>