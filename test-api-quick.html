<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€ŸAPIæ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f8ff; }
        .test { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        pre { background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸš€ å¿«é€ŸAPIæ¸¬è©¦</h1>
    
    <div class="test">
        <h3>æ­¥é©Ÿ 1: æ¸¬è©¦å¾Œç«¯é€£æ¥</h3>
        <button onclick="testBackend()">æ¸¬è©¦å¾Œç«¯</button>
        <div id="backendResult"></div>
    </div>

    <div class="test">
        <h3>æ­¥é©Ÿ 2: Jeffreyç™»å…¥</h3>
        <button onclick="loginJeffrey()">ç™»å…¥Jeffrey</button>
        <div id="loginResult"></div>
    </div>

    <div class="test">
        <h3>æ­¥é©Ÿ 3: æ¸¬è©¦æ–°API</h3>
        <button onclick="testLatestAPI()">æ¸¬è©¦ /messages/latest</button>
        <button onclick="testUnreadAPI()">æ¸¬è©¦ /messages/unread</button>
        <div id="apiResult"></div>
    </div>

    <div class="test">
        <h3>æ­¥é©Ÿ 4: å‰ç«¯çµ„ä»¶æ¸¬è©¦</h3>
        <button onclick="testFrontend()">æ‰“é–‹ç³»çµ±æ¸¬è©¦å‰ç«¯</button>
    </div>

    <script>
        let token = '';

        async function testBackend() {
            try {
                const response = await fetch('http://localhost:3004/health');
                const result = await response.json();
                document.getElementById('backendResult').innerHTML = 
                    '<div class="success">âœ… å¾Œç«¯æ­£å¸¸<pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
            } catch (error) {
                document.getElementById('backendResult').innerHTML = 
                    '<div class="error">âŒ å¾Œç«¯é€£æ¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function loginJeffrey() {
            try {
                // å˜—è©¦Jeffrey
                let response = await fetch('http://localhost:3004/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'Jeffrey', password: 'pm123' })
                });

                let result = await response.json();
                
                if (!result.success) {
                    // å˜—è©¦pm001
                    response = await fetch('http://localhost:3004/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: 'pm001', password: 'pm123' })
                    });
                    result = await response.json();
                }

                if (result.success) {
                    token = result.data.token;
                    document.getElementById('loginResult').innerHTML = 
                        '<div class="success">âœ… ç™»å…¥æˆåŠŸ<pre>' + JSON.stringify(result.data.user, null, 2) + '</pre></div>';
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        '<div class="error">âŒ ç™»å…¥å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    '<div class="error">âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function testLatestAPI() {
            if (!token) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            try {
                const response = await fetch('http://localhost:3004/api/messages/latest', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                document.getElementById('apiResult').innerHTML = 
                    '<div class="success"><h4>âœ… Latest API çµæœï¼š</h4><pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
            } catch (error) {
                document.getElementById('apiResult').innerHTML = 
                    '<div class="error">âŒ Latest API å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function testUnreadAPI() {
            if (!token) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            try {
                const response = await fetch('http://localhost:3004/api/messages/unread', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                document.getElementById('apiResult').innerHTML += 
                    '<div class="success"><h4>âœ… Unread API çµæœï¼š</h4><pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
            } catch (error) {
                document.getElementById('apiResult').innerHTML += 
                    '<div class="error">âŒ Unread API å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        function testFrontend() {
            if (token) {
                // è¨­ç½®localStorageç„¶å¾Œæ‰“é–‹ç³»çµ±
                localStorage.setItem('authToken', token);
                localStorage.setItem('userRole', 'PM');
                localStorage.setItem('username', 'Jeffrey');
                
                const user = {
                    id: 'user-2',
                    username: 'Jeffrey',
                    role: 'PM',
                    email: 'pm001@yunshui.com'
                };
                localStorage.setItem('user', JSON.stringify(user));
            }
            
            window.open('http://localhost:5173', '_blank');
        }

        // è‡ªå‹•æ¸¬è©¦
        window.onload = function() {
            setTimeout(testBackend, 500);
            setTimeout(loginJeffrey, 1500);
            setTimeout(testLatestAPI, 3000);
            setTimeout(testUnreadAPI, 4000);
        };
    </script>
</body>
</html>