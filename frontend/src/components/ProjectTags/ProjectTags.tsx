import React, { useState, useEffect } from 'react';
import { Project } from '../../types';
import { projectService } from '../../services/projectService';
import './ProjectTags.css';

interface ProjectTagsProps {
  selectedProjectId?: string;
  onProjectSelect: (projectId: string | null) => void;
  onProjectDelete?: (projectId: string) => void;
  onProjectCreate?: (projectName: string) => void;
  showManagementButtons?: boolean;
  className?: string;
}

export const ProjectTags: React.FC<ProjectTagsProps> = ({
  selectedProjectId,
  onProjectSelect,
  onProjectDelete,
  onProjectCreate,
  showManagementButtons = false,
  className = ''
}) => {
  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(false);
  const [showCreateInput, setShowCreateInput] = useState(false);
  const [newProjectName, setNewProjectName] = useState('');
  const [currentPage, setCurrentPage] = useState(0);
  const [editMode, setEditMode] = useState(false);
  const [editingProjects, setEditingProjects] = useState<{[key: string]: string}>({});
  const projectsPerPage = 10; // ÊØèÈ†ÅÈ°ØÁ§∫ÁöÑÂ∞àÊ°àÊï∏Èáè (2x5 Á∂≤Ê†º)

  useEffect(() => {
    loadProjects();
  }, []);

  const loadProjects = async () => {
    try {
      setLoading(true);
      const response = await projectService.getAllProjects();
      
      if (response.success && Array.isArray(response.data)) {
        // Âè™È°ØÁ§∫Ê¥ªË∫çÁöÑÂ∞àÊ°àÔºåÊô∫ËÉΩÈÅéÊøæËá™ÂãïÂâµÂª∫ÁöÑÂ∞àÊ°à
        const activeProjects = response.data.filter(p => {
          if (p.overallStatus !== 'ACTIVE') return false;
          
          // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ëá™ÂãïÁîüÊàêÁöÑÂ∞àÊ°àÂêçÁ®±Ê†ºÂºè
          const isAutoGenerated = (
            p.projectName.match(/^ËºîÊùêÂ∞àÊ°à-\d{4}-\d{2}-\d{2}-(order-|id-)\d+$/) ||
            p.projectName.match(/^ÊàêÂìÅÂ∞àÊ°à-\d{4}-\d{2}-\d{2}-(order-|id-)\d+$/)
          );
          
          // Â¶ÇÊûú‰∏çÊòØËá™ÂãïÁîüÊàêÊ†ºÂºèÔºåÂâáÈ°ØÁ§∫ÔºàÂåÖÊã¨ÈáçÂëΩÂêçÁöÑÂ∞àÊ°àÔºâ
          if (!isAutoGenerated) return true;
          
          // Â¶ÇÊûúÊòØËá™ÂãïÁîüÊàêÊ†ºÂºèÔºå‰ΩÜÊúâÊâãÂãïÊèèËø∞Ôºå‰πüÈ°ØÁ§∫
          if (p.description && p.description !== 'Ëá™ÂãïÂâµÂª∫ÁöÑÂ∞àÊ°à' && p.description.trim() !== '') {
            return true;
          }
          
          // ÂÖ∂‰ªñÊÉÖÊ≥ÅÔºàÁ¥îËá™ÂãïÁîüÊàêÁöÑÂ∞àÊ°àÔºâ‰∏çÈ°ØÁ§∫
          return false;
        });
        
        setProjects(activeProjects);
        console.log('‚úÖ Â∞àÊ°àÂàóË°®ËºâÂÖ•ÊàêÂäü:', activeProjects.length, 'ÂÄãÂ∞àÊ°à');
        console.log('üìã Â∞àÊ°àÂàóË°®:', activeProjects.map(p => ({ id: p.id, name: p.projectName, desc: p.description })));
        console.log('üîß showManagementButtons:', showManagementButtons);
      }
    } catch (error) {
      console.error('ËºâÂÖ•Â∞àÊ°àÂ§±Êïó:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleTagClick = (projectId: string) => {
    if (selectedProjectId === projectId) {
      // Â¶ÇÊûúÈªûÊìäÂ∑≤ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÔºåÂèñÊ∂àÈÅ∏Êìá
      onProjectSelect(null);
    } else {
      // ÈÅ∏ÊìáÊñ∞ÁöÑÂ∞àÊ°à
      onProjectSelect(projectId);
    }
  };

  const handleShowAll = () => {
    onProjectSelect(null);
  };

  const handleDeleteProject = async (e: React.MouseEvent, projectId: string) => {
    e.stopPropagation(); // Èò≤Ê≠¢Ëß∏ÁôºÊ®ôÁ±§ÈªûÊìä
    
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Á≥ªÁµ±ÂâµÂª∫ÁöÑÂ∞àÊ°à
    if (project.projectName.includes('ËºîÊùêÂ∞àÊ°à-') || project.projectName.includes('ÊàêÂìÅÂ∞àÊ°à-')) {
      alert('Á≥ªÁµ±Ëá™ÂãïÂâµÂª∫ÁöÑÂ∞àÊ°àÁÑ°Ê≥ïÂà™Èô§');
      return;
    }
    
    if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Â∞àÊ°à„Äå${project.projectName}„ÄçÂóéÔºü\n\nÊ≥®ÊÑèÔºöÈÄô‰∏çÊúÉÂà™Èô§Ë®ÇÂñÆÔºåÂè™ÊúÉÂ∞áË®ÇÂñÆÂæûÂ∞àÊ°à‰∏≠ÁßªÈô§„ÄÇ`)) {
      try {
        const response = await projectService.deleteProject(projectId);
        if (response.success) {
          // Êõ¥Êñ∞Êú¨Âú∞Â∞àÊ°àÂàóË°®
          setProjects(prev => prev.filter(p => p.id !== projectId));
          
          // Â¶ÇÊûúÂà™Èô§ÁöÑÊòØÁï∂ÂâçÈÅ∏‰∏≠ÁöÑÂ∞àÊ°àÔºåÂàáÊèõÂà∞ÂÖ®ÈÉ®Ë®ÇÂñÆ
          if (selectedProjectId === projectId) {
            onProjectSelect(null);
          }
          
          // ÈÄöÁü•Áà∂ÁµÑ‰ª∂
          if (onProjectDelete) {
            onProjectDelete(projectId);
          }
          
          alert('Â∞àÊ°àÂ∑≤Âà™Èô§ÔºåÁõ∏ÈóúË®ÇÂñÆÂ∑≤ÁßªÈô§Â∞àÊ°àÊ≠∏Â±¨');
        } else {
          // Êõ¥Ë©≥Á¥∞ÁöÑÈåØË™§ËôïÁêÜ
          let errorMessage = response.message || 'Âà™Èô§Â§±Êïó';
          if (errorMessage.includes('404')) {
            errorMessage = 'Â∞àÊ°à‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà™Èô§';
          } else if (errorMessage.includes('403')) {
            errorMessage = 'Ê≤íÊúâÊ¨äÈôêÂà™Èô§Ê≠§Â∞àÊ°à';
          } else if (errorMessage.includes('400')) {
            errorMessage = 'Â∞àÊ°àÂèØËÉΩÊúâÈóúËÅØÁöÑË®ÇÂñÆÔºåÁÑ°Ê≥ïÂà™Èô§';
          }
          alert(`Âà™Èô§Â§±Êïó: ${errorMessage}`);
        }
      } catch (error: any) {
        console.error('Âà™Èô§Â∞àÊ°àÂ§±Êïó:', error);
        let errorMessage = error.message || 'Á∂≤Ë∑ØÈåØË™§';
        if (errorMessage.includes('404')) {
          errorMessage = 'Â∞àÊ°à‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà™Èô§';
        } else if (errorMessage.includes('403')) {
          errorMessage = 'Ê≤íÊúâÊ¨äÈôêÂà™Èô§Ê≠§Â∞àÊ°à';
        }
        alert(`Âà™Èô§Â§±Êïó: ${errorMessage}`);
      }
    }
  };

  const handleCreateProject = async () => {
    if (!newProjectName.trim()) {
      alert('Ë´ãËº∏ÂÖ•Â∞àÊ°àÂêçÁ®±');
      return;
    }
    
    try {
      const response = await projectService.createProject({
        projectName: newProjectName.trim(),
        description: 'ÊâãÂãïÂâµÂª∫ÁöÑÂ∞àÊ°à'
      });
      
      if (response.success && response.data) {
        const newProject = response.data as Project;
        
        // ÈáçÁΩÆËº∏ÂÖ•ÁãÄÊÖã
        setNewProjectName('');
        setShowCreateInput(false);
        
        // ÈáçÊñ∞ËºâÂÖ•Â∞àÊ°àÂàóË°®‰ª•Á¢∫‰øùÊï∏ÊìöÂêåÊ≠•
        await loadProjects();
        
        // ÈÄöÁü•Áà∂ÁµÑ‰ª∂
        if (onProjectCreate) {
          onProjectCreate(newProject.projectName);
        }
        
        alert(`Â∞àÊ°à„Äå${newProject.projectName}„ÄçÂâµÂª∫ÊàêÂäüÔºÅ`);
      } else {
        alert(`ÂâµÂª∫Â§±Êïó: ${response.message}`);
      }
    } catch (error: any) {
      console.error('ÂâµÂª∫Â∞àÊ°àÂ§±Êïó:', error);
      alert(`ÂâµÂª∫Â§±Êïó: ${error.message}`);
    }
  };

  const handleCancelCreate = () => {
    setShowCreateInput(false);
    setNewProjectName('');
  };

  // Á∑®ËºØÊ®°ÂºèÁõ∏ÈóúÂáΩÊï∏
  const handleEditMode = () => {
    if (editMode) {
      // ÈÄÄÂá∫Á∑®ËºØÊ®°ÂºèÔºåÈáçÁΩÆÁ∑®ËºØÁãÄÊÖã
      setEditingProjects({});
    } else {
      // ÈÄ≤ÂÖ•Á∑®ËºØÊ®°ÂºèÔºåÂàùÂßãÂåñÁ∑®ËºØÁãÄÊÖã
      const editState: {[key: string]: string} = {};
      currentProjects.forEach(project => {
        editState[project.id] = project.projectName;
      });
      setEditingProjects(editState);
    }
    setEditMode(!editMode);
  };

  const handleProjectNameChange = (projectId: string, newName: string) => {
    setEditingProjects(prev => ({
      ...prev,
      [projectId]: newName
    }));
  };

  const handleSaveProjectName = async (projectId: string) => {
    const newName = editingProjects[projectId]?.trim();
    if (!newName) {
      alert('Â∞àÊ°àÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫');
      return;
    }

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    if (newName === project.projectName) {
      // ÂêçÁ®±Ê≤íÊúâËÆäÂåñÔºåÁõ¥Êé•ËøîÂõû
      return;
    }

    try {
      // Á¢∫‰øùÈáçÂëΩÂêçÁöÑÂ∞àÊ°àÊúâÊèèËø∞Ê®ôË®òÔºå‰ª•‰æøÊ≠£Á¢∫È°ØÁ§∫
      const updatedDescription = project.description || 'Áî®Êà∂ÈáçÂëΩÂêçÁöÑÂ∞àÊ°à';
      
      const response = await projectService.updateProject(projectId, {
        projectName: newName,
        description: updatedDescription
      });

      if (response.success) {
        // ÈáçÊñ∞ËºâÂÖ•Â∞àÊ°àÂàóË°®‰ª•Á¢∫‰øùÊï∏ÊìöÂêåÊ≠•
        await loadProjects();
        
        // ÈÄöÁü•Áà∂ÁµÑ‰ª∂Â∞àÊ°àÂ∑≤Êõ¥Êñ∞Ôºà‰ΩÜ‰∏çÊòØÂâµÂª∫Ôºâ
        if (onProjectCreate) {
          onProjectCreate(newName);
        }
        
        alert(`Â∞àÊ°àÂêçÁ®±Â∑≤Êõ¥Êñ∞ÁÇ∫„Äå${newName}„Äç`);
      } else {
        alert(`Êõ¥Êñ∞Â§±Êïó: ${response.message}`);
        // ÊÅ¢Âæ©ÂéüÂßãÂêçÁ®±
        setEditingProjects(prev => ({
          ...prev,
          [projectId]: project.projectName
        }));
      }
    } catch (error: any) {
      console.error('Êõ¥Êñ∞Â∞àÊ°àÂêçÁ®±Â§±Êïó:', error);
      alert(`Êõ¥Êñ∞Â§±Êïó: ${error.message}`);
      // ÊÅ¢Âæ©ÂéüÂßãÂêçÁ®±
      setEditingProjects(prev => ({
        ...prev,
        [projectId]: project.projectName
      }));
    }
  };

  // ÂàÜÈ†ÅÈÇèËºØ
  const totalPages = Math.ceil(projects.length / projectsPerPage);
  const startIndex = currentPage * projectsPerPage;
  const endIndex = startIndex + projectsPerPage;
  const currentProjects = projects.slice(startIndex, endIndex);
  const showPagination = projects.length > projectsPerPage;

  const handleNextPage = () => {
    if (currentPage < totalPages - 1) {
      setCurrentPage(currentPage + 1);
    }
  };

  const handlePrevPage = () => {
    if (currentPage > 0) {
      setCurrentPage(currentPage - 1);
    }
  };

  if (loading) {
    return (
      <div className={`project-tags ${className}`}>
        <span className="loading-text">ËºâÂÖ•Â∞àÊ°à‰∏≠...</span>
      </div>
    );
  }

  if (projects.length === 0 && !loading) {
    return (
      <div className={`project-tags ${className}`}>
        <span className="no-projects-text">Â∞öÁÑ°Â∞àÊ°à</span>
      </div>
    );
  }

  return (
    <div className={`project-tags ${className}`}>
      <div className="project-tags-header">
        <div className="header-left">
          <button
            className={`project-tag all-tag ${!selectedProjectId ? 'active' : ''}`}
            onClick={handleShowAll}
          >
            üìã ÂÖ®ÈÉ®
          </button>
          
          {showPagination && (
            <div className="pagination-info">
              Á¨¨ {currentPage + 1} È†ÅÔºåÂÖ± {totalPages} È†Å
            </div>
          )}
        </div>
        
        <div className="header-controls">
          {showManagementButtons && (
            <>
              {showCreateInput ? (
                <div className="header-create-input">
                  <input
                    type="text"
                    value={newProjectName}
                    onChange={(e) => setNewProjectName(e.target.value)}
                    placeholder="Ëº∏ÂÖ•Â∞àÊ°àÂêçÁ®±"
                    maxLength={50}
                    autoFocus
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') handleCreateProject();
                      if (e.key === 'Escape') handleCancelCreate();
                    }}
                    className="header-project-input"
                  />
                  <button
                    className="header-confirm-btn"
                    onClick={handleCreateProject}
                    disabled={!newProjectName.trim()}
                  >
                    ‚úì
                  </button>
                  <button
                    className="header-cancel-btn"
                    onClick={handleCancelCreate}
                  >
                    √ó
                  </button>
                </div>
              ) : (
                <>
                  <button
                    className="create-project-btn"
                    onClick={() => setShowCreateInput(true)}
                    title="ÂâµÂª∫Êñ∞Â∞àÊ°à"
                  >
                    + Êñ∞Â∞àÊ°à
                  </button>
                  <button
                    className={`edit-mode-btn ${editMode ? 'active' : ''}`}
                    onClick={handleEditMode}
                    title={editMode ? 'ÈÄÄÂá∫Á∑®ËºØÊ®°Âºè' : 'Á∑®ËºØÂ∞àÊ°àÂêçÁ®±'}
                  >
                    {editMode ? '‚úì ÂÆåÊàê' : '‚úèÔ∏è Á∑®ËºØ'}
                  </button>
                </>
              )}
            </>
          )}
        </div>
      </div>
      
      <div className="project-tags-grid">
        {currentProjects.map(project => (
          <div key={project.id} className="project-tag-wrapper">
            {editMode ? (
              <div className="project-edit-item">
                <input
                  type="text"
                  value={editingProjects[project.id] || project.projectName}
                  onChange={(e) => handleProjectNameChange(project.id, e.target.value)}
                  onBlur={() => handleSaveProjectName(project.id)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      handleSaveProjectName(project.id);
                    }
                  }}
                  className="project-name-input"
                  maxLength={50}
                />
                {showManagementButtons && (
                  <button
                    className="project-delete-btn-edit"
                    onClick={(e) => {
                      e.stopPropagation();
                      handleDeleteProject(e, project.id);
                    }}
                    title={`Âà™Èô§Â∞àÊ°à„Äå${project.projectName}„Äç`}
                  >
                    √ó
                  </button>
                )}
              </div>
            ) : (
              <button
                className={`project-tag ${selectedProjectId === project.id ? 'active' : ''}`}
                onClick={() => handleTagClick(project.id)}
                title={`Â∞àÊ°àÔºö${project.projectName}`}
              >
                <span className="project-icon">üìÅ</span>
                <span className="project-name">{project.projectName}</span>
              </button>
            )}
          </div>
        ))}

      </div>
      
      {showPagination && (
        <div className="project-tags-pagination">
          <button
            className="pagination-btn"
            onClick={handlePrevPage}
            disabled={currentPage === 0}
            title="‰∏ä‰∏ÄÈ†Å"
          >
            ‚Äπ
          </button>
          <button
            className="pagination-btn"
            onClick={handleNextPage}
            disabled={currentPage >= totalPages - 1}
            title="‰∏ã‰∏ÄÈ†Å"
          >
            ‚Ä∫
          </button>
        </div>
      )}
    </div>
  );
};