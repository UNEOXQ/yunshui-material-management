# 測試指南\n\n本專案包含完整的測試套件，涵蓋單元測試、整合測試和端到端測試。\n\n## 測試架構\n\n### 測試類型\n\n1. **單元測試 (Unit Tests)**\n   - 測試個別函數和組件\n   - 快速執行，獨立性高\n   - 使用 Jest 和 React Testing Library\n\n2. **整合測試 (Integration Tests)**\n   - 測試系統組件間的互動\n   - 包含 API 整合和資料庫操作\n   - 使用真實的資料庫和服務\n\n3. **端到端測試 (E2E Tests)**\n   - 測試完整的使用者工作流程\n   - 模擬真實使用者操作\n   - 驗證系統整體功能\n\n### 測試結構\n\n```\nbackend/src/tests/\n├── unit/                    # 單元測試\n│   ├── controllers/\n│   ├── services/\n│   ├── models/\n│   └── utils/\n├── integration/             # 整合測試\n│   ├── api.integration.test.ts\n│   └── system.integration.test.ts\n├── e2e/                     # 端到端測試\n│   └── user-workflow.e2e.test.ts\n└── setup/                   # 測試設定\n    └── integration.setup.ts\n\nfrontend/src/tests/\n├── unit/                    # 單元測試\n│   ├── components/\n│   ├── hooks/\n│   ├── services/\n│   └── utils/\n└── integration/             # 整合測試\n    └── app.integration.test.tsx\n```\n\n## 執行測試\n\n### 後端測試\n\n```bash\ncd backend\n\n# 執行所有測試\nnpm test\n\n# 執行單元測試\nnpm run test:unit\n\n# 執行整合測試\nnpm run test:integration\n\n# 執行端到端測試\nnpm run test:e2e\n\n# 執行所有測試（單元 + 整合）\nnpm run test:all\n\n# 監視模式\nnpm test -- --watch\n\n# 產生覆蓋率報告\nnpm test -- --coverage\n```\n\n### 前端測試\n\n```bash\ncd frontend\n\n# 執行所有測試\nnpm test\n\n# 監視模式\nnpm test -- --watch\n\n# 產生覆蓋率報告\nnpm test -- --coverage\n```\n\n### 完整整合測試\n\n```bash\n# 使用 Docker 執行完整測試套件\nnode scripts/run-integration-tests.js\n\n# 或使用 Make\nmake test\n```\n\n## 測試配置\n\n### 環境設定\n\n測試使用獨立的環境配置：\n\n- **後端**: `.env.test`\n- **前端**: `.env.test`\n- **資料庫**: 獨立的測試資料庫\n- **Redis**: 獨立的 Redis 實例\n\n### Jest 配置\n\n#### 單元測試配置 (`jest.config.js`)\n```javascript\nmodule.exports = {\n  preset: 'ts-jest',\n  testEnvironment: 'node',\n  testMatch: ['**/*.test.ts', '**/*.spec.ts'],\n  testPathIgnorePatterns: ['integration', 'e2e'],\n  collectCoverageFrom: ['src/**/*.ts'],\n  coverageThreshold: {\n    global: {\n      branches: 80,\n      functions: 80,\n      lines: 80,\n      statements: 80\n    }\n  }\n};\n```\n\n#### 整合測試配置 (`jest.integration.config.js`)\n```javascript\nmodule.exports = {\n  preset: 'ts-jest',\n  testEnvironment: 'node',\n  testMatch: ['**/*.(integration|e2e).test.ts'],\n  setupFilesAfterEnv: ['<rootDir>/src/tests/setup/integration.setup.ts'],\n  testTimeout: 30000,\n  maxWorkers: 1\n};\n```\n\n## 測試最佳實踐\n\n### 1. 測試命名\n\n```typescript\n// 好的測試命名\ndescribe('UserService', () => {\n  describe('createUser', () => {\n    it('should create user with valid data', async () => {\n      // 測試實作\n    });\n    \n    it('should throw error when email already exists', async () => {\n      // 測試實作\n    });\n  });\n});\n```\n\n### 2. 測試結構 (AAA Pattern)\n\n```typescript\nit('should calculate total price correctly', () => {\n  // Arrange - 準備測試資料\n  const materials = [\n    { quantity: 2, unitPrice: 100 },\n    { quantity: 3, unitPrice: 200 }\n  ];\n  \n  // Act - 執行被測試的功能\n  const total = calculateTotalPrice(materials);\n  \n  // Assert - 驗證結果\n  expect(total).toBe(800);\n});\n```\n\n### 3. Mock 使用\n\n```typescript\n// Mock 外部依賴\njest.mock('../services/emailService');\nconst mockEmailService = emailService as jest.Mocked<typeof emailService>;\n\nit('should send notification email', async () => {\n  mockEmailService.sendEmail.mockResolvedValue(true);\n  \n  await userService.createUser(userData);\n  \n  expect(mockEmailService.sendEmail).toHaveBeenCalledWith(\n    userData.email,\n    'Welcome'\n  );\n});\n```\n\n### 4. 資料庫測試\n\n```typescript\ndescribe('Database Integration', () => {\n  beforeEach(async () => {\n    // 清理測試資料\n    await cleanDatabase();\n  });\n  \n  afterEach(async () => {\n    // 清理測試資料\n    await cleanDatabase();\n  });\n  \n  it('should persist user data', async () => {\n    const user = await userService.createUser(userData);\n    const savedUser = await userService.findById(user.id);\n    \n    expect(savedUser).toMatchObject(userData);\n  });\n});\n```\n\n### 5. 前端組件測試\n\n```typescript\nimport { render, screen, fireEvent } from '@testing-library/react';\nimport userEvent from '@testing-library/user-event';\n\nit('should submit form with valid data', async () => {\n  const user = userEvent.setup();\n  const onSubmit = jest.fn();\n  \n  render(<MaterialForm onSubmit={onSubmit} />);\n  \n  await user.type(screen.getByLabelText(/名稱/), 'Test Material');\n  await user.type(screen.getByLabelText(/價格/), '100');\n  await user.click(screen.getByRole('button', { name: /提交/ }));\n  \n  expect(onSubmit).toHaveBeenCalledWith({\n    name: 'Test Material',\n    price: 100\n  });\n});\n```\n\n## 測試資料管理\n\n### 測試資料工廠\n\n```typescript\n// tests/factories/userFactory.ts\nexport const createUserData = (overrides = {}) => ({\n  username: 'testuser',\n  email: 'test@example.com',\n  role: 'PM',\n  password: 'password123',\n  ...overrides\n});\n\nexport const createMaterialData = (overrides = {}) => ({\n  name: 'Test Material',\n  category: 'Test Category',\n  price: 100.00,\n  quantity: 50,\n  type: 'AUXILIARY',\n  ...overrides\n});\n```\n\n### 測試資料清理\n\n```typescript\n// 清理函數\nexport async function cleanDatabase() {\n  const client = await pool.connect();\n  try {\n    await client.query('BEGIN');\n    await client.query('DELETE FROM order_materials');\n    await client.query('DELETE FROM orders');\n    await client.query('DELETE FROM materials');\n    await client.query('DELETE FROM users WHERE username LIKE \\'test%\\'');\n    await client.query('COMMIT');\n  } catch (error) {\n    await client.query('ROLLBACK');\n    throw error;\n  } finally {\n    client.release();\n  }\n}\n```\n\n## 持續整合 (CI/CD)\n\n### GitHub Actions\n\n測試會在以下情況自動執行：\n- Push 到 main 或 develop 分支\n- 創建 Pull Request\n- 手動觸發\n\n### 測試流程\n\n1. **環境設定**\n   - 啟動 PostgreSQL 和 Redis 服務\n   - 安裝依賴\n   - 設定環境變數\n\n2. **資料庫準備**\n   - 執行資料庫遷移\n   - 設定測試資料\n\n3. **測試執行**\n   - 單元測試\n   - 整合測試\n   - 端到端測試\n\n4. **報告生成**\n   - 覆蓋率報告\n   - 測試結果報告\n   - 上傳到 Codecov\n\n## 效能測試\n\n### 負載測試\n\n```typescript\ndescribe('Performance Tests', () => {\n  it('should handle concurrent requests', async () => {\n    const requests = Array(100).fill(null).map(() => \n      request(app)\n        .get('/api/materials')\n        .set('Authorization', `Bearer ${token}`)\n    );\n    \n    const startTime = Date.now();\n    const responses = await Promise.all(requests);\n    const duration = Date.now() - startTime;\n    \n    responses.forEach(response => {\n      expect(response.status).toBe(200);\n    });\n    \n    expect(duration).toBeLessThan(5000); // 5秒內完成\n  });\n});\n```\n\n### 記憶體洩漏測試\n\n```typescript\nit('should not have memory leaks', async () => {\n  const initialMemory = process.memoryUsage().heapUsed;\n  \n  // 執行大量操作\n  for (let i = 0; i < 1000; i++) {\n    await materialService.createMaterial(createMaterialData());\n    await materialService.deleteMaterial(materialId);\n  }\n  \n  // 強制垃圾回收\n  if (global.gc) {\n    global.gc();\n  }\n  \n  const finalMemory = process.memoryUsage().heapUsed;\n  const memoryIncrease = finalMemory - initialMemory;\n  \n  expect(memoryIncrease).toBeLessThan(10 * 1024 * 1024); // 10MB\n});\n```\n\n## 故障排除\n\n### 常見問題\n\n1. **測試超時**\n   ```bash\n   # 增加超時時間\n   jest --testTimeout=30000\n   ```\n\n2. **資料庫連線問題**\n   ```bash\n   # 檢查資料庫狀態\n   docker-compose ps database\n   \n   # 重啟資料庫\n   docker-compose restart database\n   ```\n\n3. **端口衝突**\n   ```bash\n   # 檢查端口使用\n   lsof -i :3001\n   \n   # 終止進程\n   kill -9 <PID>\n   ```\n\n4. **快取問題**\n   ```bash\n   # 清除 Jest 快取\n   npx jest --clearCache\n   \n   # 清除 npm 快取\n   npm cache clean --force\n   ```\n\n### 除錯技巧\n\n1. **使用 console.log**\n   ```typescript\n   it('should debug test', () => {\n     console.log('Debug info:', testData);\n     // 測試邏輯\n   });\n   ```\n\n2. **使用 debugger**\n   ```typescript\n   it('should debug with breakpoint', () => {\n     debugger; // 設定中斷點\n     // 測試邏輯\n   });\n   ```\n\n3. **只執行特定測試**\n   ```bash\n   # 執行特定測試檔案\n   npm test -- user.test.ts\n   \n   # 執行特定測試案例\n   npm test -- --testNamePattern=\"should create user\"\n   ```\n\n## 測試覆蓋率\n\n### 目標覆蓋率\n\n- **語句覆蓋率**: 80%+\n- **分支覆蓋率**: 80%+\n- **函數覆蓋率**: 80%+\n- **行覆蓋率**: 80%+\n\n### 查看覆蓋率報告\n\n```bash\n# 生成覆蓋率報告\nnpm test -- --coverage\n\n# 開啟 HTML 報告\nopen coverage/lcov-report/index.html\n```\n\n### 排除檔案\n\n```javascript\n// jest.config.js\ncollectCoverageFrom: [\n  'src/**/*.{ts,tsx}',\n  '!src/**/*.d.ts',\n  '!src/tests/**',\n  '!src/**/*.test.{ts,tsx}'\n]\n```\n\n## 相關資源\n\n- [Jest 文件](https://jestjs.io/docs/getting-started)\n- [React Testing Library](https://testing-library.com/docs/react-testing-library/intro/)\n- [Supertest](https://github.com/visionmedia/supertest)\n- [MSW (Mock Service Worker)](https://mswjs.io/)\n- [Testing Best Practices](https://github.com/goldbergyoni/javascript-testing-best-practices)"