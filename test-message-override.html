<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ç•™è¨€è¦†è“‹åŠŸèƒ½</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
        }
        .test-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .info {
            border-left-color: #17a2b8;
            background-color: #d1ecf1;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        input, textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            font-size: 14px;
        }
        textarea {
            width: 100%;
            resize: vertical;
        }
        .message-timeline {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .message-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”„ ç•™è¨€è¦†è“‹åŠŸèƒ½æ¸¬è©¦</h1>
        
        <div class="info">
            <h3>ğŸ¯ æ¸¬è©¦ç›®æ¨™</h3>
            <p>é©—è­‰æ–°çš„ç•™è¨€è¦†è“‹é‚è¼¯ï¼š</p>
            <ul>
                <li>âœ… æ°¸é åªé¡¯ç¤ºä¸€æ¢ç•™è¨€ï¼ˆæœ€æ–°çš„ï¼‰</li>
                <li>âœ… æ–°ç•™è¨€è‡ªå‹•è¦†è“‹èˆŠç•™è¨€</li>
                <li>âœ… ä¸ç®¡ç•™è¨€æ˜¯å¦å·²è®€éƒ½è¦é¡¯ç¤º</li>
                <li>âœ… å„ªå…ˆé¡¯ç¤ºæœªè®€ç•™è¨€ï¼Œæ²’æœ‰æœªè®€æ™‚é¡¯ç¤ºæœ€æ–°å·²è®€ç•™è¨€</li>
            </ul>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 1: ç®¡ç†å“¡ç™»å…¥</h3>
            <button onclick="loginAdmin()">ç™»å…¥ç®¡ç†å“¡</button>
            <div id="adminLoginResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 2: Jeffreyç™»å…¥</h3>
            <button onclick="loginJeffrey()">ç™»å…¥Jeffrey</button>
            <div id="jeffreyLoginResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 3: æª¢æŸ¥Jeffreyç•¶å‰çœ‹åˆ°çš„ç•™è¨€</h3>
            <button onclick="checkCurrentMessage()">æª¢æŸ¥ç•¶å‰ç•™è¨€</button>
            <div id="currentMessageResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 4: ç™¼é€æ–°ç•™è¨€æ¸¬è©¦è¦†è“‹</h3>
            <div>
                <textarea id="newMessageContent" rows="3" placeholder="è¼¸å…¥æ–°ç•™è¨€å…§å®¹...">æ¸¬è©¦è¦†è“‹ç•™è¨€ - ${new Date().toLocaleString()}</textarea>
            </div>
            <button onclick="sendNewMessage()">ç™¼é€æ–°ç•™è¨€çµ¦Jeffrey</button>
            <div id="sendMessageResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 5: é©—è­‰ç•™è¨€æ˜¯å¦è¦†è“‹</h3>
            <button onclick="checkMessageAfterSend()">æª¢æŸ¥Jeffreyçš„æœ€æ–°ç•™è¨€</button>
            <div id="afterSendResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 6: æ¸¬è©¦å·²è®€ç‹€æ…‹</h3>
            <button onclick="markAsRead()">æ¨™è¨˜ç•¶å‰ç•™è¨€ç‚ºå·²è®€</button>
            <button onclick="checkAfterRead()">æª¢æŸ¥æ¨™è¨˜å·²è®€å¾Œçš„é¡¯ç¤º</button>
            <div id="readTestResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 7: é€£çºŒç™¼é€æ¸¬è©¦</h3>
            <button onclick="sendMultipleMessages()">é€£çºŒç™¼é€3æ¢ç•™è¨€</button>
            <div id="multipleResult"></div>
        </div>

        <div class="step">
            <h3>ğŸ“‹ ç•™è¨€æ™‚é–“è»¸</h3>
            <div id="messageTimeline" class="message-timeline">
                <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...</p>
            </div>
        </div>
    </div>

    <script>
        let adminToken = '';
        let jeffreyToken = '';
        let currentMessageId = '';
        let messageHistory = [];

        async function loginAdmin() {
            try {
                const response = await fetch('http://localhost:3004/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                const result = await response.json();
                
                if (result.success) {
                    adminToken = result.data.token;
                    document.getElementById('adminLoginResult').innerHTML = 
                        '<div class="step success">âœ… ç®¡ç†å“¡ç™»å…¥æˆåŠŸ</div>';
                } else {
                    document.getElementById('adminLoginResult').innerHTML = 
                        '<div class="step error">âŒ ç®¡ç†å“¡ç™»å…¥å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('adminLoginResult').innerHTML = 
                    '<div class="step error">âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function loginJeffrey() {
            try {
                // å˜—è©¦ç”¨Jeffreyç™»å…¥
                const response = await fetch('http://localhost:3004/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'Jeffrey', password: 'pm123' })
                });

                const result = await response.json();
                
                if (result.success) {
                    jeffreyToken = result.data.token;
                    document.getElementById('jeffreyLoginResult').innerHTML = 
                        '<div class="step success">âœ… Jeffreyç™»å…¥æˆåŠŸ</div>';
                } else {
                    // å¦‚æœJeffreyç™»å…¥å¤±æ•—ï¼Œå˜—è©¦ç”¨pm001
                    const response2 = await fetch('http://localhost:3004/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: 'pm001', password: 'pm123' })
                    });
                    
                    const result2 = await response2.json();
                    if (result2.success) {
                        jeffreyToken = result2.data.token;
                        document.getElementById('jeffreyLoginResult').innerHTML = 
                            '<div class="step success">âœ… Jeffreyç™»å…¥æˆåŠŸ (ä½¿ç”¨pm001)</div>';
                    } else {
                        document.getElementById('jeffreyLoginResult').innerHTML = 
                            '<div class="step error">âŒ Jeffreyç™»å…¥å¤±æ•—ï¼š' + result.message + '</div>';
                    }
                }
            } catch (error) {
                document.getElementById('jeffreyLoginResult').innerHTML = 
                    '<div class="step error">âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function checkCurrentMessage() {
            if (!jeffreyToken) {
                alert('è«‹å…ˆç™»å…¥Jeffrey');
                return;
            }

            try {
                // æª¢æŸ¥æœªè®€ç•™è¨€
                const unreadResponse = await fetch('http://localhost:3004/api/messages/unread', {
                    headers: { 'Authorization': `Bearer ${jeffreyToken}` }
                });
                const unreadResult = await unreadResponse.json();

                // æª¢æŸ¥æœ€æ–°ç•™è¨€
                const latestResponse = await fetch('http://localhost:3004/api/messages/latest', {
                    headers: { 'Authorization': `Bearer ${jeffreyToken}` }
                });
                const latestResult = await latestResponse.json();

                let displayHtml = '<div class="step success">';
                displayHtml += `<h4>æœªè®€ç•™è¨€ (${unreadResult.data ? unreadResult.data.length : 0} æ¢)ï¼š</h4>`;
                if (unreadResult.data && unreadResult.data.length > 0) {
                    displayHtml += `<pre>${JSON.stringify(unreadResult.data, null, 2)}</pre>`;
                } else {
                    displayHtml += '<p>ç„¡æœªè®€ç•™è¨€</p>';
                }

                displayHtml += '<h4>æœ€æ–°ç•™è¨€ï¼š</h4>';
                if (latestResult.success && latestResult.data) {
                    displayHtml += `<pre>${JSON.stringify(latestResult.data, null, 2)}</pre>`;
                    currentMessageId = latestResult.data.id;
                } else {
                    displayHtml += '<p>ç„¡ç•™è¨€</p>';
                }
                displayHtml += '</div>';

                document.getElementById('currentMessageResult').innerHTML = displayHtml;
                updateTimeline();
            } catch (error) {
                document.getElementById('currentMessageResult').innerHTML = 
                    '<div class="step error">âŒ æª¢æŸ¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function sendNewMessage() {
            if (!adminToken) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
                return;
            }

            const content = document.getElementById('newMessageContent').value;
            if (!content.trim()) {
                alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
                return;
            }

            try {
                const response = await fetch('http://localhost:3004/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        toUserId: 'user-2', // Jeffreyçš„ID
                        content: content.trim()
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    messageHistory.push({
                        time: new Date().toLocaleString(),
                        action: 'ç™¼é€ç•™è¨€',
                        content: content.trim(),
                        messageId: result.data.id
                    });
                    
                    document.getElementById('sendMessageResult').innerHTML = 
                        '<div class="step success">âœ… æ–°ç•™è¨€ç™¼é€æˆåŠŸ</div>';
                    updateTimeline();
                } else {
                    document.getElementById('sendMessageResult').innerHTML = 
                        '<div class="step error">âŒ ç™¼é€å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('sendMessageResult').innerHTML = 
                    '<div class="step error">âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function checkMessageAfterSend() {
            await checkCurrentMessage();
            document.getElementById('afterSendResult').innerHTML = 
                '<div class="step info">âœ… å·²æ›´æ–°ä¸Šæ–¹çš„ç•™è¨€æª¢æŸ¥çµæœ</div>';
        }

        async function markAsRead() {
            if (!jeffreyToken || !currentMessageId) {
                alert('è«‹å…ˆæª¢æŸ¥ç•¶å‰ç•™è¨€');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3004/api/messages/${currentMessageId}/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${jeffreyToken}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    messageHistory.push({
                        time: new Date().toLocaleString(),
                        action: 'æ¨™è¨˜å·²è®€',
                        messageId: currentMessageId
                    });
                    
                    document.getElementById('readTestResult').innerHTML = 
                        '<div class="step success">âœ… ç•™è¨€å·²æ¨™è¨˜ç‚ºå·²è®€</div>';
                    updateTimeline();
                } else {
                    document.getElementById('readTestResult').innerHTML = 
                        '<div class="step error">âŒ æ¨™è¨˜å¤±æ•—ï¼š' + result.message + '</div>';
                }
            } catch (error) {
                document.getElementById('readTestResult').innerHTML = 
                    '<div class="step error">âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        async function checkAfterRead() {
            await checkCurrentMessage();
            document.getElementById('readTestResult').innerHTML += 
                '<div class="step info">âœ… å·²æ›´æ–°ç•™è¨€æª¢æŸ¥çµæœ</div>';
        }

        async function sendMultipleMessages() {
            if (!adminToken) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
                return;
            }

            const messages = [
                'ç¬¬ä¸€æ¢æ¸¬è©¦ç•™è¨€ - ' + new Date().toLocaleString(),
                'ç¬¬äºŒæ¢æ¸¬è©¦ç•™è¨€ - ' + new Date().toLocaleString(),
                'ç¬¬ä¸‰æ¢æ¸¬è©¦ç•™è¨€ - ' + new Date().toLocaleString()
            ];

            let results = [];
            
            for (let i = 0; i < messages.length; i++) {
                try {
                    const response = await fetch('http://localhost:3004/api/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({
                            toUserId: 'user-2',
                            content: messages[i]
                        })
                    });

                    const result = await response.json();
                    results.push(`ç•™è¨€ ${i+1}: ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
                    
                    messageHistory.push({
                        time: new Date().toLocaleString(),
                        action: `ç™¼é€ç•™è¨€ ${i+1}`,
                        content: messages[i]
                    });
                    
                    // æ¯æ¢ç•™è¨€é–“éš”1ç§’
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    results.push(`ç•™è¨€ ${i+1}: âŒ éŒ¯èª¤ - ${error.message}`);
                }
            }

            document.getElementById('multipleResult').innerHTML = 
                '<div class="step success"><h4>é€£çºŒç™¼é€çµæœï¼š</h4><ul>' + 
                results.map(r => `<li>${r}</li>`).join('') + 
                '</ul></div>';
            
            updateTimeline();
        }

        function updateTimeline() {
            const timeline = document.getElementById('messageTimeline');
            if (messageHistory.length === 0) {
                timeline.innerHTML = '<p>æš«ç„¡æ“ä½œè¨˜éŒ„</p>';
                return;
            }

            const timelineHtml = messageHistory.map(item => `
                <div class="message-item">
                    <strong>${item.time}</strong> - ${item.action}
                    ${item.content ? `<br><em>"${item.content}"</em>` : ''}
                    ${item.messageId ? `<br><small>ID: ${item.messageId}</small>` : ''}
                </div>
            `).join('');

            timeline.innerHTML = timelineHtml;
        }

        // é é¢è¼‰å…¥æ™‚çš„æç¤º
        window.onload = function() {
            console.log('ğŸ”„ ç•™è¨€è¦†è“‹åŠŸèƒ½æ¸¬è©¦é é¢å·²è¼‰å…¥');
        };
    </script>
</body>
</html>